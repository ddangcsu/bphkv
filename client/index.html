<!DOCTYPE html>
<html lang="en" data-theme="light">

<head>
  <meta charset="utf-8" />
  <title>BPHKV Application</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="./css/light.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
</head>

<body>
  <div id="app" v-cloak>
    <div class="topbar">
      <!-- LEFT: Burger + Breadcrumb -->
      <div class="leftbar">
        <!-- Burger Menu -->
        <div class="menu-wrap" :class="{ open: menuOpen }">
          <button tabindex="-1" class="btn menu-btn" type="button" @click="menuOpen = !menuOpen" aria-haspopup="menu"
            :aria-expanded="menuOpen">
            <i class="fa-solid fa-house"></i> <span>Home</span>
          </button>
          <div v-if="menuOpen" class="clickout-overlay" @click="menuOpen=false"></div>
          <div v-if="menuOpen" class="menu-panel" role="menu">
            <button tabindex="-1" v-for="m in BURGER_MENU" :key="m.id" class="btn secondary menu-item" type="button"
              role="menuitem" @click="m.onClick(m.id)">
              <i :class="m.icon"></i> {{ m.label }}
            </button>
          </div>
        </div>

        <!-- Breadcrumbs -->
        <div class="crumb">
          <h4 class="crumb-text">
            <template v-for="(c,i) in breadcrumbs" :key="i">
              <template v-if="i>0"> &gt; </template>
              <a v-if="c.onClick" class="link" href="#" @click.prevent="c.onClick">{{ c.label }}</a>
              <span v-else>{{ c.label }}</span>
            </template>
          </h4>
        </div>
      </div>

      <!-- CENTER: Status -->
      <div class="statusbar">
        <div class="status" v-show="status.visible" :data-variant="status.variant">
          <i :class="statusIcon"></i>
          <span v-text="status.text"></span>
        </div>
      </div>

      <!-- RIGHT: Actions -->
      <nav class="actionbar">
        <button tabindex="-1" v-if="SECTION.FAMILIES && MODE.LIST" class="btn primary" type="button"
          @click="beginCreateFamily">
          <i class="fa-solid fa-plus"></i> <span>Family</span>
        </button>

        <button tabindex="-1" v-if="SECTION.EVENTS && MODE.LIST" class="btn primary" type="button"
          @click="beginCreateEvent">
          <i class="fa-solid fa-plus"></i> <span>Event</span>
        </button>

        <button tabindex="-1" v-if="SECTION.REGISTRATIONS && MODE.LIST" class="btn primary" type="button"
          @click="beginCreateRegistration">
          <i class="fa-solid fa-plus"></i> <span>Registration</span>
        </button>
      </nav>
    </div>

    <transition name="fade" mode="out-in">
      <!-- ====================== FAMILIES ====================== -->
      <main v-if="SECTION.FAMILIES">
        <!-- List -->
        <section v-if="MODE.LIST" class="page">
          <div class="card">
            <div class="toolbar">
              <input v-model.trim="familySearch" class="input"
                placeholder="Search familyId, membership #, contact name/phone/email, city..." autocomplete="off" />
              <button tabindex="-1" class="btn small" type="button" @click="resetFamilyFilters"
                :disabled="!hasActiveFamilyFilter" title="Clear filters">
                Clear
              </button>
            </div>
            <table class="table">
              <thead>
                <tr>
                  <th>Family ID</th>
                  <th>Member</th>
                  <th>Parish#</th>
                  <th>Contact Info</th>
                  <th>City</th>
                  <th># Children</th>
                  <th>Actions</th>
                  <th>BPH</th>
                  <th>TNTT</th>
                </tr>
              </thead>
              <tbody>
                <template v-for="f in filteredFamilyRows" :key="f.id">
                  <tr>
                    <td>{{ f.id }}</td>
                    <td class="badge" :data-variant="codeToLabel(f.parishMember, YES_NO_OPTIONS)">{{
                      codeToLabel(f.parishMember, YES_NO_OPTIONS) }}</td>
                    <td>{{ f.parishNumber || '-' }}</td>
                    <td v-html="contactDisplay(f)"></td>
                    <td>{{ f.address.city }}</td>
                    <td>{{ f.children.length }}</td>
                    <td>
                      <button tabindex="-1" class="btn" type="button" @click="beginEditFamily(f)">
                        <i class="fa-solid fa-pen-to-square"></i><span> Edit</span>
                      </button>
                    </td>
                    <td>
                      <button tabindex="-1" class="btn" type="button" @click="registerAdminForFamily(f)">
                        <template v-if="alreadyRegistered({familyId: f.id, programId: PROGRAM.BPH})">
                          <i class="fa-solid fa-dollar-sign"></i> <span> Paid </span>
                        </template>
                        <template v-else>
                          <i class="fa-solid fa-clipboard-list"></i><span> Enroll</span>
                        </template>
                      </button>
                    </td>
                    <td>
                      <button tabindex="-1" v-if="alreadyRegistered({familyId: f.id, programId: PROGRAM.BPH })"
                        class="btn" type="button" @click="registerTNTTForFamily(f)">
                        <template v-if="alreadyRegistered({familyId: f.id, programId: PROGRAM.TNTT, eventType: EVENT.REGISTRATION
                          })">
                          <i class="fa-solid fa-dollar-sign"></i> <span> Paid </span>
                        </template>
                        <template v-else>
                          <i class="fa-solid fa-clipboard-list"></i><span> Enroll</span>
                        </template>
                      </button>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </section>

        <!-- Form -->
        <section v-else class="page">
          <form class="card form" @submit.prevent.stop="submitFamilyForm" novalidate autocomplete="off">
            <div class="formtabs-bar">
              <nav class="formtabs" role="tablist" aria-label="Family form sections">
                <button tabindex="-1" type="button" class="active" role="tab" aria-controls="panel-family">
                  Family Information
                </button>
              </nav>

              <div class="formtabs-actions">
                <button v-show="MODE.EDIT" type="button" class="btn" @click="READONLY = !READONLY">
                  <i :class="READONLY ? 'fa-solid fa-lock' : 'fa-solid fa-lock-open'"></i>
                </button>
                <button tabindex="-1" type="button" class="btn primary" :disabled="isReadOnly || !isFamilyDirty"
                  @click="submitFamilyForm">
                  <i class="fa-solid fa-floppy-disk"></i><span> Save</span>
                </button>
                <button tabindex="-1" type="button" class="btn" @click="goBackSection">
                  <i class="fa-solid fa-xmark"></i><span> Cancel</span>
                </button>
              </div>
            </div>

            <!-- Household -->
            <section id="panel-household" role="tabpanel" class="subpanel">
              <div class="item-header compact bordered">
                <h4 class="title">{{`Household Information of ${parentLastNamesDisplay} Family`}}</h4>
              </div>

              <div>
                <div class="grid">
                  <label v-for="f in familyFields.household.main" :key="f.col" :for="`household-${f.col}`"
                    v-show="isVisible(f, {form: familyForm})">
                    {{ f.label }}
                    <small class="error" v-if="familyErrors?.household?.[f.col]">{{
                      familyErrors.household[f.col]
                      }}</small>

                    <template v-if="f.type === 'select'">
                      <select class="input" :id="`household-${f.col}`" :name="`family.${f.col}`"
                        v-model="familyForm[f.col]"
                        :disabled="getFieldDisabled(f, {mode: currentMode, form: familyForm})"
                        @input="onFormFieldInput(f, {form: familyForm }, $event)"
                        @change="onFormFieldChange(f, {form: familyForm }, $event)">
                        <option disabled value="">-- choose --</option>
                        <option v-for="opt in getOptions(f, {form: familyForm})" :key="String(opt.value)"
                          :value="opt.value">
                          {{ formatOptionLabel(opt) }}
                        </option>
                      </select>
                    </template>

                    <template v-else-if="f.type === 'checkbox'">
                      <input class="check-lg" type="checkbox" :id="`household-${f.col}`" :name="`family.${f.col}`"
                        :disabled="getFieldDisabled(f, {mode: currentMode, form: familyForm})"
                        v-model="familyForm[f.col]" @input="onFormFieldInput(f, {form: familyForm }, $event)"
                        @change="onFormFieldChange(f, {form: familyForm }, $event)" />
                    </template>

                    <template v-else>
                      <input class="input" :type="f.type || 'text'" :id="`household-${f.col}`" :name="`family.${f.col}`"
                        v-model.trim="familyForm[f.col]" :placeholder="f.placeholder"
                        :disabled="getFieldDisabled(f, {mode: currentMode, form: familyForm})"
                        @input="onFormFieldInput(f, {form: familyForm }, $event)"
                        @change="onFormFieldChange(f, {form: familyForm }, $event)" />
                    </template>
                  </label>
                </div>

                <div class="grid">
                  <label v-for="f in familyFields.household.address" :key="f.col" :for="`household-address-${f.col}`"
                    v-show="isVisible(f, {form: familyForm})">
                    {{ f.label }}
                    <small class="error" v-if="familyErrors?.household?.[f.col]">{{
                      familyErrors.household[f.col]
                      }}</small>

                    <template v-if="f.type === 'select'">
                      <select class="input" :id="`household-address-${f.col}`" :name="`family.address.${f.col}`"
                        v-model="familyForm.address[f.col]"
                        :disabled="getFieldDisabled(f, {mode: currentMode, form: familyForm})"
                        @input="onFormFieldInput(f, {form: familyForm }, $event)"
                        @change="onFormFieldChange(f, {form: familyForm }, $event)">
                        <option disabled value="">-- choose --</option>
                        <option v-for="opt in getOptions(f, {form: familyForm})" :key="String(opt.value)"
                          :value="opt.value">
                          {{ formatOptionLabel(opt) }}
                        </option>
                      </select>
                    </template>

                    <template v-else-if="f.type === 'checkbox'">
                      <input class="check-lg" type="checkbox" :id="`household-address-${f.col}`"
                        :name="`family.address.${f.col}`"
                        :disabled="getFieldDisabled(f, {mode: currentMode, form: familyForm})"
                        v-model="familyForm.address[f.col]" @input="onFormFieldInput(f, {form: familyForm }, $event)"
                        @change="onFormFieldChange(f, {form: familyForm }, $event)" />
                    </template>

                    <template v-else>
                      <input class="input" :type="f.type || 'text'" :id="`household-address-${f.col}`"
                        :name="`family.address.${f.col}`"
                        :disabled="getFieldDisabled(f, {mode: currentMode, form: familyForm})"
                        v-model.trim="familyForm.address[f.col]" :placeholder="f.placeholder"
                        @input="onFormFieldInput(f, {form: familyForm }, $event)"
                        @change="onFormFieldChange(f, {form: familyForm }, $event)" />
                    </template>
                  </label>
                </div>
              </div>
            </section>

            <!-- Contacts -->
            <section id="panel-contacts" role="tabpanel" class="subpanel">
              <!-- Contacts Header and actions -->
              <div class="item-header compact bordered">
                <h4 class="title">Contacts Information</h4>
                <div class="spacer"></div>
                <div class="pager" v-if="familyContactsMode==='single'">
                  <button tabindex="-1" type="button" class="btn small" @click="prevFamilyContact"
                    :disabled="familyContactsIndex===0">◀</button>
                  <span class="pager-status">{{ familyContactsIndex+1 }} / {{
                    familyForm.contacts.length }}</span>
                  <button tabindex="-1" type="button" class="btn small" @click="nextFamilyContact"
                    :disabled="familyContactsIndex>=familyForm.contacts.length-1">▶</button>
                </div>
                <div class="seg">
                  <button tabindex="-1" type="button" :class="{ 'seg-active': familyContactsMode==='single' }"
                    @click="familyContactsMode='single'">One</button>
                  <button tabindex="-1" type="button" :class="{ 'seg-active': familyContactsMode==='all' }"
                    @click="familyContactsMode='all'">All</button>
                </div>
                <div class="actions">
                  <button tabindex="-1" type="button" class="btn small accent" :disabled="isReadOnly"
                    @click="addFamilyContact"><i class="fa-solid fa-plus"></i></button>
                </div>
              </div>
              <!-- Contacts Row -->
              <div v-for="row in visibleFamilyContacts" :key="'c'+row.i" class="row">
                <div class="row-actions">
                  <button tabindex="-1" type="button" class="btn small danger" :disabled="isReadOnly"
                    @click="removeFamilyContact(row.i)" v-if="familyForm.contacts.length>1">
                    <i class="fa-solid fa-minus"></i>
                  </button>
                </div>

                <div class="grid">
                  <label v-for="f in familyFields.contacts" :key="f.col" :for="`contact-${row.i}-${f.col}`"
                    v-show="isVisible(f, {form: row.c})">
                    {{ f.label }}
                    <small class="error" v-if="familyErrors?.contacts?.[row.i]?.[f.col]">{{
                      familyErrors.contacts[row.i][f.col] }}</small>

                    <template v-if="f.type === 'select'">
                      <select class="input" :id="`contact-${row.i}-${f.col}`"
                        :name="`family.contacts[${row.i}].${f.col}`"
                        :disabled="getFieldDisabled(f, {mode: currentMode, form: familyForm})" v-model="row.c[f.col]"
                        @input="onFormFieldInput(f, {form: row.c }, $event)"
                        @change="onFormFieldChange(f, {form: row.c }, $event)">
                        <option disabled value="">-- choose --</option>
                        <option v-for="opt in getOptions(f, {form: row.c})" :key="String(opt.value)" :value="opt.value">
                          {{ formatOptionLabel(opt) }}
                        </option>
                      </select>
                    </template>

                    <template v-else-if="f.type === 'checkbox'">
                      <input class="check-lg" type="checkbox" :id="`contact-${row.i}-${f.col}`"
                        :name="`family.contacts[${row.i}].${f.col}`"
                        :disabled="getFieldDisabled(f, {mode: currentMode, form: familyForm})" v-model="row.c[f.col]"
                        @input="onFormFieldInput(f, {form: row.c }, $event)"
                        @change="onFormFieldChange(f, {form: row.c }, $event)" />
                    </template>

                    <template v-else>
                      <input class="input" :type="f.type || 'text'" :id="`contact-${row.i}-${f.col}`"
                        :name="`family.contacts[${row.i}].${f.col}`"
                        :disabled="getFieldDisabled(f, {mode: currentMode, form: familyForm})"
                        v-model.trim="row.c[f.col]" :placeholder="f.placeholder"
                        @input="onFormFieldInput(f, {form: row.c }, $event)"
                        @change="onFormFieldChange(f, {form: row.c }, $event)" />
                    </template>
                  </label>
                </div>
              </div>
            </section>

            <!-- Children -->
            <section id="panel-children" role="tabpanel" class="subpanel">
              <!-- Children Header and Actions-->
              <div class="item-header compact bordered">
                <h4 class="title">Children Information</h4>
                <div class="spacer"></div>
                <div class="pager" v-if="familyChildrenMode==='single'">
                  <button tabindex="-1" type="button" class="btn small" @click="prevFamilyChild"
                    :disabled="familyChildrenIndex===0">◀</button>
                  <span class="pager-status">{{ familyChildrenIndex+1 }} / {{
                    familyForm.children.length }}</span>
                  <button tabindex="-1" type="button" class="btn small" @click="nextFamilyChild"
                    :disabled="familyChildrenIndex>=familyForm.children.length-1">▶</button>
                </div>
                <div class="seg">
                  <button tabindex="-1" type="button" :class="{ 'seg-active': familyChildrenMode==='single' }"
                    @click="familyChildrenMode='single'">One</button>
                  <button tabindex="-1" type="button" :class="{ 'seg-active': familyChildrenMode==='all' }"
                    @click="familyChildrenMode='all'">All</button>
                </div>
                <div class="actions">
                  <button tabindex="-1" type="button" class="btn small accent" :disabled="isReadOnly"
                    @click="addFamilyChild">
                    <i class="fa-solid fa-plus"></i>
                  </button>
                </div>
              </div>

              <div class="row" v-for="row in visibleFamilyChildren" :key="'k'+row.i">
                <div class="item-header compact">
                  <div class="title">
                    <span>ID: {{row.c.childId}} - {{displayChildNameAndAge(row.c)}}</span>
                  </div>
                  <div class="row-actions">
                    <button tabindex="-1" type="button" class="btn small danger" :disabled="isReadOnly"
                      @click="removeFamilyChild(row.i)" v-if="familyForm.children.length>1">
                      <i class="fa-solid fa-minus"></i>
                    </button>
                  </div>
                </div>

                <div class="grid">
                  <label v-for="f in familyFields.children" :key="f.col" :for="`child-${row.i}-${f.col}`"
                    v-show="isVisible(f, {form: row.c})">
                    {{ f.label }}
                    <small class="error" v-if="familyErrors?.children?.[row.i]?.[f.col]">{{
                      familyErrors.children[row.i][f.col] }}</small>

                    <template v-if="f.type === 'select'">
                      <select class="input" :id="`child-${row.i}-${f.col}`" :name="`family.children[${row.i}].${f.col}`"
                        :disabled="getFieldDisabled(f, {mode: currentMode, form: familyForm})" v-model="row.c[f.col]"
                        @input="onFormFieldInput(f, {form: row.c }, $event)"
                        @change="onFormFieldChange(f, {form: row.c }, $event)">
                        <option disabled value="">-- choose --</option>
                        <option v-for="opt in getOptions(f, {form: familyForm})" :key="String(opt.value)"
                          :value="opt.value">
                          {{ formatOptionLabel(opt) }}
                        </option>
                      </select>
                    </template>

                    <template v-else-if="f.type === 'checkbox'">
                      <input class="check-lg" type="checkbox" :id="`child-${row.i}-${f.col}`"
                        :name="`family.children[${row.i}].${f.col}`"
                        :disabled="getFieldDisabled(f, {mode: currentMode, form: familyForm})" v-model="row.c[f.col]"
                        @input="onFormFieldInput(f, {form: row.c }, $event)"
                        @change="onFormFieldChange(f, {form: row.c }, $event)" />
                    </template>

                    <template v-else>
                      <input class="input" :type="f.type || 'text'" :id="`child-${row.i}-${f.col}`"
                        :name="`family.children[${row.i}].${f.col}`"
                        :disabled="getFieldDisabled(f, {mode: currentMode, form: familyForm})"
                        v-model.trim="row.c[f.col]" :placeholder="f.placeholder"
                        @input="onFormFieldInput(f, {form: row.c }, $event)"
                        @change="onFormFieldChange(f, {form: row.c }, $event)" />
                    </template>
                  </label>
                </div>
              </div>
            </section>
          </form>
        </section>
      </main>

      <!-- ======================= EVENTS ======================= -->
      <main v-else-if="SECTION.EVENTS">
        <!-- List -->
        <section v-if="MODE.LIST" class="page">
          <div class="card">
            <div class="toolbar">
              <input v-model.trim="eventSearch" class="input" placeholder="Search by id, title, type, program, year…" />

              <div class="toolbar-filters">
                <!-- Program -->
                <label class="toolbar-filter">
                  <span>Program</span>
                  <select class="input" v-model="eventFilter.programId">
                    <option value="">All programs</option>
                    <option v-for="opt in PROGRAM_OPTIONS" :key="String(opt.value)" :value="opt.value">
                      {{ formatOptionLabel(opt) }}
                    </option>
                  </select>
                </label>

                <!-- Year -->
                <label class="toolbar-filter">
                  <span>Year</span>
                  <select class="input" v-model="eventFilter.year">
                    <option value="">All years</option>
                    <option v-for="opt in YEAR_OPTIONS" :key="String(opt.value)" :value="opt.value">
                      {{ opt.label }}
                    </option>
                  </select>
                </label>

                <!-- Level -->
                <label class="toolbar-filter">
                  <span>Scope</span>
                  <select class="input" v-model="eventFilter.level">
                    <option value="">All levels</option>
                    <option v-for="opt in LEVEL_OPTIONS" :key="String(opt.value)" :value="opt.value">
                      {{ formatOptionLabel(opt) }}
                    </option>
                  </select>
                </label>
              </div>
              <button tabindex="-1" class="btn small" type="button" @click="resetEventFilters"
                :disabled="!hasActiveEventFilter" title="Clear Program/Level/Year filters">
                Clear
              </button>
            </div>

            <table class="table">
              <thead>
                <tr>
                  <th>Event ID</th>
                  <th>Program</th>
                  <th>Type</th>
                  <th>Description</th>
                  <th>School Year</th>
                  <th>Scope</th>
                  <th>Open Window</th>
                  <th>Schedule Fees</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="ev in filteredEventRows" :key="ev.id">
                  <td>{{ ev.id }}</td>
                  <td>{{ ev.programId }}</td>
                  <td>{{ codeToLabel(ev.eventType, EVENT_TYPES) || '—' }}</td>
                  <td>{{ ev.title }}</td>
                  <td>{{ codeToLabel(ev.year, YEAR_OPTIONS) }}</td>
                  <td>{{ codeToLabel(ev.level, LEVEL_OPTIONS) }}</td>
                  <td>{{ ev.openDate }} → {{ ev.endDate }}</td>
                  <td>{{ displayEventFees(ev) }}</td>
                  <td class="actions">
                    <button tabindex="-1" class="btn secondary" type="button" @click="beginEditEvent(ev)">
                      <i class="fa-solid fa-pen-to-square"></i> Edit
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>

        <!-- Form -->
        <section v-else class="page">
          <form class="card form" @submit.prevent.stop="submitEventForm" novalidate autocomplete="off">
            <div class="formtabs-bar">
              <nav class="formtabs" role="tablist" aria-label="Event Form Section">
                <button tabindex="-1" type="button" class="active" role="tab" aria-selected="true"
                  aria-controls="panel-event">
                  Event Information
                </button>
              </nav>

              <div class="formtabs-actions">
                <button v-show="MODE.EDIT" type="button" class="btn" @click="READONLY = !READONLY">
                  <i :class="READONLY ? 'fa-solid fa-lock' : 'fa-solid fa-lock-open'"></i>
                </button>
                <button tabindex="-1" type="button" class="btn primary"
                  :disabled="isReadOnly || !canSaveEvent || !isEventDirty" @click="submitEventForm">
                  <i class="fa-solid fa-floppy-disk"></i><span> Save</span>
                </button>
                <button tabindex="-1" type="button" class="btn secondary" @click="goBackSection">
                  <i class="fa-solid fa-xmark"></i><span> Cancel</span>
                </button>
              </div>
            </div>

            <!-- Meta-driven main fields -->
            <section class="subpanel" id="panel-event" role="tabpanel">
              <div class="item-header compact bordered">
                <h4 class="title">Event Information</h4>
              </div>

              <div class="grid">
                <label v-for="fld in eventFields.main" :key="fld.col" v-show="isVisible(fld, {form: eventForm})"
                  :for="`event-${fld.col}`">
                  {{ fld.label }}
                  <small class="error" v-if="eventErrors[fld.col]">{{ eventErrors[fld.col]
                    }}</small>

                  <template v-if="fld.type === 'select'">
                    <select class="input" v-model="eventForm[fld.col]" :id="`event-${fld.col}`"
                      :name="`event.${fld.col}`" :disabled="getFieldDisabled(fld, {mode: currentMode, form: eventForm})"
                      @input="onFormFieldInput(fld, {form: eventForm }, $event)"
                      @change="onFormFieldChange(fld, {form: eventForm }, $event)">
                      <option disabled value="">-- choose --</option>
                      <option v-for="opt in getOptions(fld, {form: eventForm})" :key="String(opt.value)"
                        :value="opt.value">
                        {{ formatOptionLabel(opt) }}
                      </option>
                    </select>
                  </template>

                  <template v-else-if="fld.type === 'checkbox'">
                    <input class="check-lg" type="checkbox" v-model="eventForm[fld.col]" :id="`event-${fld.col}`"
                      :name="`event.${fld.col}`" :disabled="getFieldDisabled(fld, {mode: currentMode, form: eventForm})"
                      @input="onFormFieldInput(fld, {form: eventForm }, $event)"
                      @change="onFormFieldChange(fld, {form: eventForm }, $event)" />
                  </template>

                  <template v-else>
                    <input class="input" :type="fld.type || 'text'" v-model.trim="eventForm[fld.col]"
                      :id="`event-${fld.col}`" :name="`event.${fld.col}`" :placeholder="fld.placeholder"
                      v-bind="fld.attrs || {}" :disabled="getFieldDisabled(fld, {mode: currentMode, form: eventForm})"
                      @input="onFormFieldInput(fld, {form: eventForm }, $event)"
                      @change="onFormFieldChange(fld, {form: eventForm }, $event)" />
                  </template>
                </label>
              </div>
            </section>

            <!-- Fees -->
            <section class="subpanel">
              <div class="item-header compact bordered">
                <h4 class="title">Event Fees</h4>
                <div class="spacer"></div>
                <div class="actions">
                  <button tabindex="-1" class="btn small accent" type="button" :disabled="isReadOnly"
                    @click="addEventFee">
                    <i class="fa-solid fa-plus"></i>
                  </button>
                </div>
              </div>

              <div class="row" v-for="(row,i) in eventForm.fees" :key="'fee'+i">
                <div tabindex="-1" class="row-actions" style="align-self:end">
                  <button class="btn small danger" type="button" :disabled="isReadOnly" @click="removeEventFee(i)"
                    v-if="eventForm.fees.length>1">
                    <i class="fa-solid fa-minus"></i>
                  </button>
                </div>

                <div class="grid">
                  <label v-for="rf in eventFields.feeRow" :key="rf.col" :for="`event-fee-${i}-${rf.col}`"
                    v-show="isVisible(rf, {form: row})">
                    {{ rf.label }}
                    <template v-if="rf.type==='select'">
                      <select class="input" v-model="row[rf.col]" :id="`event-fee-${i}-${rf.col}`"
                        :name="`event.fees[${i}].${rf.col}`"
                        :disabled="getFieldDisabled(rf, {mode: currentMode, form: eventForm})"
                        @input="onFormFieldInput(rf, {form: row }, $event)"
                        @change="onFormFieldChange(rf, {form: row }, $event)">
                        <option disabled value="">-- choose --</option>
                        <option v-for="opt in getOptions(rf, {form: eventForm})" :key="String(opt.value)"
                          :value="opt.value">
                          {{ formatOptionLabel(opt) }}
                        </option>
                      </select>
                    </template>
                    <template v-else>
                      <input class="input" :type="rf.type || 'text'" v-model.number="row[rf.col]"
                        :disabled="getFieldDisabled(rf, {mode: currentMode, form: eventForm})"
                        :id="`event-fee-${i}-${rf.col}`" :name="`event.fees[${i}].${rf.col}`" v-bind="rf.attrs || {}"
                        @input="onFormFieldInput(rf, {form: row }, $event)"
                        @change="onFormFieldChange(rf, {form: row }, $event)" />
                    </template>
                  </label>
                  <small class="error" v-if="eventErrors.fees">{{ eventErrors.fees }}</small>
                </div>
              </div>
            </section>

            <!-- Prerequisites: shown for non-ADM only -->
            <section class="subpanel" v-if="showPrerequisites">
              <div class="item-header compact bordered">
                <h4 class="title">Event Prerequisites</h4>
                <div class="spacer"></div>
                <div class="actions">
                  <button tabindex="-1" class="btn small accent" type="button" :disabled="isReadOnly"
                    @click="addEventPrerequisiteRow">
                    <i class="fa-solid fa-plus"></i>
                  </button>
                </div>
              </div>

              <div class="row" v-for="(p, i) in eventForm.prerequisites" :key="'pre'+i">
                <!-- Actions -->
                <div class="row-actions" style="align-self:end">
                  <button tabindex="-1" class="btn small danger" type="button" :disabled="isReadOnly"
                    @click="removeEventPrerequisiteRow(i)" v-if="eventForm.prerequisites.length>1">
                    <i class="fa-solid fa-minus"></i>
                  </button>
                </div>

                <div class="grid">
                  <!-- Driving control -->
                  <template v-for="pf in eventFields.prerequisiteRow" :key="pf.col">
                    <label :for="`event-prereq-${i}-${pf.col}`" v-show="isVisible(pf, {form: p})">
                      {{ pf.label }}
                      <select class="input" v-model="p[pf.col]" :id="`event-prereq-${i}-${pf.col}`"
                        :name="`event.prerequisites[${i}].${pf.col}`"
                        :disabled="getFieldDisabled(pf, {mode: currentMode, form: eventForm})"
                        @input="onFormFieldInput(pf, {form: p }, $event)"
                        @change="onFormFieldChange(pf, {form: p }, $event)">
                        <option disabled value="">-- choose --</option>
                        <option v-for="opt in getOptions(pf, { index:i, form: eventForm })" :key="String(opt.value)"
                          :value="opt.value">
                          {{ formatOptionLabel(opt) }}
                        </option>
                      </select>
                    </label>

                    <!-- Relative displays -->
                    <label v-for="rd in (pf.relativeDisplay || [])" :key="pf.col + '::' + rd.label">
                      {{ rd.label }}
                      <input class="input" :id="`event-prereq-${i}-${pf.col}-${rd.label}`"
                        :name="`event.prerequisites[${i}].rd.${rd.label}`" disabled
                        :value="relativeDisplayValue(p, pf, rd)" />
                    </label>
                  </template>

                  <small class="error" v-if="eventErrors.prerequisites">{{ eventErrors.prerequisites
                    }}</small>
                </div>
              </div>
            </section>
          </form>
        </section>
      </main>

      <!-- =================== REGISTRATIONS ==================== -->
      <main v-else-if="SECTION.REGISTRATIONS">
        <!-- List -->
        <section v-if="MODE.LIST" class="page">
          <div class="card">
            <div class="toolbar">
              <input v-model.trim="registrationSearch" class="input" placeholder="Search by reg id, event, family…" />

              <div class="toolbar-filters">
                <!-- Program -->
                <label class="toolbar-filter">
                  <span>Program</span>
                  <select class="input" v-model="registrationFilter.programId">
                    <option value="">All programs</option>
                    <option v-for="opt in PROGRAM_OPTIONS" :key="String(opt.value)" :value="opt.value">
                      {{ formatOptionLabel(opt) }}
                    </option>
                  </select>
                </label>

                <!-- Event Type -->
                <label class="toolbar-filter">
                  <span>Type</span>
                  <select class="input" v-model="registrationFilter.eventType">
                    <option value="">All types</option>
                    <option v-for="opt in EVENT_TYPES" :key="String(opt.value)" :value="opt.value">
                      {{ formatOptionLabel(opt) }}
                    </option>
                  </select>
                </label>

                <!-- School Year -->
                <label class="toolbar-filter">
                  <span>Year</span>
                  <select class="input" v-model="registrationFilter.year">
                    <option value="">All years</option>
                    <option v-for="opt in YEAR_OPTIONS" :key="String(opt.value)" :value="opt.value">
                      {{ opt.label }}
                    </option>
                  </select>
                </label>

              </div>
              <button tabindex="-1" class="btn small" type="button" @click="resetRegFilters"
                :disabled="!hasActiveRegFilter" title="Clear filters">
                Clear
              </button>
            </div>

            <table class="table">
              <thead>
                <tr>
                  <th>Reg ID</th>
                  <th>Event Type</th>
                  <th>School Year</th>
                  <th>Program</th>
                  <th>Family</th>
                  <th># Children</th>
                  <th>Status</th>
                  <th>Payments</th>
                  <th>Updated</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="r in filteredRegistrationRows" :key="r.id">
                  <td>{{ r.id }}</td>
                  <td>{{ codeToLabel(r.event?.eventType, EVENT_TYPES) }}</td>
                  <td>{{ codeToLabel(r.event?.year, YEAR_OPTIONS) }} </td>
                  <td>{{ r.event?.programId }}</td>
                  <td v-html="contactDisplay(r)"></td>
                  <td>{{ r.children.length > 0 ? r.children.length: '' }}</td>
                  <td class="badge" :data-variant="r.status">
                    <a href="#" class="link" v-if="r.status === 'paid'" @click="openReceipt(r)">
                      <i class="fa-solid fa-receipt"></i> {{ r.status }}</a>
                    <span v-else>{{ r.status }}</span>
                  </td>
                  <td>{{ (r.payments||[]).map(p=>p.code+':$'+p.amount).join(' / ') }}</td>
                  <td>{{ (r.updatedAt||r.createdAt||'').slice(0,10) }}</td>
                  <td class="actions">
                    <button tabindex="-1" class="btn secondary" type="button" @click="beginEditRegistration(r)">
                      <i class="fa-solid fa-pen-to-square"></i> Edit
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>

        <!-- Form -->
        <section v-else class="page">
          <form class="card form" @submit.prevent.stop="submitRegistrationForm" novalidate autocomplete="off">
            <div class="formtabs-bar">
              <nav class="formtabs" role="tablist" aria-label="Registration form sections">
                <button tabindex="-1" type="button" class="active" role="tab" :aria-controls="'panel-registration'">
                  Manage Registration
                </button>
              </nav>
              <div class="formtabs-actions">

                <button tabindex="-1" v-show="MODE.EDIT && registrationForm.status === 'paid' " type="button"
                  class="btn" @click="openReceipt(registrationForm)">
                  <i class="fa-solid fa-receipt"></i><span> Receipt</span>
                </button>

                <button v-show="MODE.EDIT" type="button" class="btn" @click="READONLY = !READONLY">
                  <i :class="READONLY ? 'fa-solid fa-lock' : 'fa-solid fa-lock-open'"></i>
                </button>
                <button tabindex="-1" type="button" class="btn primary"
                  :disabled="isReadOnly || !canSaveRegistration || !isRegistrationDirty"
                  @click="submitRegistrationForm">
                  <i class="fa-solid fa-floppy-disk"></i><span> Save</span>
                </button>
                <button tabindex="-1" type="button" class="btn" @click="goBackSection">
                  <i class="fa-solid fa-xmark"></i><span> Cancel</span>
                </button>
              </div>
            </div>

            <!-- Event and Family data -->
            <section id="panel-reg-main" role="tabpanel" class="subpanel">
              <div class="item-header compact bordered">
                <h4 class="title">Event & Family</h4>
              </div>

              <div class="grid">
                <label v-for="fld in registrationFields.main" :key="fld.col"
                  v-show="isVisible(fld, {form: registrationForm})" :for="`reg-${fld.col}`">
                  {{ fld.label }}
                  <small class="error" v-if="registrationErrors?.main?.[fld.col]">{{
                    registrationErrors.main[fld.col]
                    }}</small>

                  <template v-if="fld.type === 'select'">
                    <select class="input" v-model="registrationForm[fld.col]" :id="`reg-${fld.col}`"
                      :name="`registration.${fld.col}`"
                      :disabled="getFieldDisabled(fld, {mode: currentMode, form: registrationForm})"
                      @input="onFormFieldInput(fld, {form: registrationForm }, $event)"
                      @change="onFormFieldChange(fld, {form: registrationForm }, $event)">
                      <option disabled value="">-- choose --</option>
                      <option v-for="opt in getOptions(fld, { form: registrationForm })" :key="String(opt.value)"
                        :value="opt.value">
                        {{ formatOptionLabel(opt) }}
                      </option>
                    </select>
                  </template>

                  <template v-else-if="fld.type === 'datalist'">
                    <input class="input" list="family-datalist" v-model="registrationForm[fld.col]"
                      :id="`reg-${fld.col}`" :name="`registration.${fld.col}`"
                      :placeholder="fld.placeholder || 'Start typing…'"
                      :disabled="getFieldDisabled(fld, {mode: currentMode, form: registrationForm})"
                      @input="onFormFieldInput(fld, {form: registrationForm }, $event)"
                      @change="onFormFieldChange(fld, {form: registrationForm }, $event)" />
                  </template>

                  <template v-else>
                    <input class="input" :type="fld.type || 'text'" v-model.trim="registrationForm[fld.col]"
                      :id="`reg-${fld.col}`" :name="`registration.${fld.col}`" :placeholder="fld.placeholder"
                      :disabled="getFieldDisabled(fld, {mode: currentMode, form: registrationForm})"
                      @input="onFormFieldInput(fld, {form: registrationForm }, $event)"
                      @change="onFormFieldChange(fld, {form: registrationForm }, $event)" />
                  </template>
                </label>
              </div>

              <!-- datalist source for Family autocomplete -->
              <datalist id="family-datalist">
                <option v-for="opt in familyDatalistOptions" :key="opt.value" :value="opt.value">{{
                  opt.label }}
                </option>
              </datalist>

              <!-- Event snapshot (disabled via meta) -->
              <div class="subpanel">
                <div class="item-header compact bordered">
                  <h4 class="title">Event Snapshot</h4>
                </div>
                <div class="grid">
                  <label v-for="f in registrationFields.eventSnapshot" :key="f.col" :for="`reg-event-${f.col}`"
                    v-show="isVisible(f, {form: registrationForm})">
                    {{ f.label }}
                    <input class="input" :id="`reg-event-${f.col}`" :name="`registration.event.${f.col}`"
                      :disabled="getFieldDisabled(f, {form: registrationForm})"
                      :value="f.transform ? f.transform(registrationForm.event[f.col]) : registrationForm.event[f.col]" />
                  </label>
                </div>
              </div>

              <!-- Contacts snapshot (disabled via meta) -->
              <div class="subpanel">
                <div class="item-header compact bordered">
                  <h4 class="title">Contacts Snapshot</h4>
                </div>
                <div class="grid col3">
                  <template v-for="(c, i) in registrationForm.contacts" :key="'rc'+i">
                    <label v-for="cf in registrationFields.contactSnapshot" :key="cf.col + i"
                      :for="`reg-contact-${i}-${cf.col}`" v-show="isVisible(cf, {form: registrationForm})">
                      {{ cf.label }}
                      <input class="input" :id="`reg-contact-${i}-${cf.col}`"
                        :name="`registration.contacts[${i}].${cf.col}`"
                        :disabled="getFieldDisabled(cf, {form: registrationForm})" :value="c[cf.col]" />
                    </label>
                  </template>
                </div>
              </div>
            </section>

            <!-- Children selection for PC events -->
            <section class="subpanel" v-if="selectedEventLevel === LEVEL.PER_CHILD">
              <div class="item-header compact bordered">
                <h4 class="title">Children Enrollment</h4>
                <div class="spacer"></div>
                <small class="error" v-if="registrationErrors?.main?.childrenRoot">{{
                  registrationErrors?.main?.childrenRoot
                  }}</small>
                <div class="actions">
                  <button tabindex="-1" class="btn small accent" type="button" @click="addRegChildRow"
                    :disabled="isReadOnly || availableChildOptions.length===0">
                    <i class="fa-solid fa-plus"></i>
                  </button>
                </div>
              </div>

              <div class="row" v-for="(row,i) in registrationForm.children" :key="'ch'+i">
                <div class="row-actions">
                  <button tabindex="-1" class="btn small danger" type="button" :disabled="isReadOnly"
                    @click="removeRegChildRow(i)" v-if="registrationForm.children.length>1">
                    <i class="fa-solid fa-minus"></i>
                  </button>
                </div>
                <div class="grid">
                  <template v-for="cf in registrationFields.childrenRow" :key="cf.col">
                    <label :for="`reg-child-${i}-${cf.col}`" v-show="isVisible(cf, {form: row})">
                      {{ cf.label }}
                      <small class="error" v-if="registrationErrors?.children?.[i]?.[cf.col]">{{
                        registrationErrors.children[i]?.[cf.col] }}</small>
                      <template v-if="cf.type === 'select'">
                        <select class="input" v-model="row[cf.col]" :id="`reg-child-${i}-${cf.col}`"
                          :name="`registration.children[${i}].${cf.col}`"
                          :disabled="getFieldDisabled(cf, {row: row, index: i})"
                          @input="onFormFieldInput(cf, {form: row, index: i }, $event)"
                          @change="onFormFieldChange(cf, {form: row, index: i }, $event)">
                          <option disabled value="">-- choose --</option>
                          <option v-for="opt in getOptions(cf, {form: row, index: i })" :key="String(opt.value)"
                            :value="opt.value">{{
                            formatOptionLabel(opt)}}</option>
                        </select>

                      </template>
                      <template v-else-if="cf.type === 'text'">
                        <input class="input" :id="`reg-child-${i}-${cf.col}`"
                          :name="`registration.children[${i}].${cf.col}`"
                          :disabled="getFieldDisabled(cf, {row: row, index: i})"
                          :value="cf.transform ? cf.transform(row[cf.col]) : row[cf.col]"
                          @input="onFormFieldInput(cf, {form: row, index: i }, $event)"
                          @change="onFormFieldChange(cf, {form: row, index: i }, $event)" />

                      </template>
                    </label>
                  </template>
                </div>

              </div>
            </section>

            <!-- Payments (prefilled, fixed rows) -->
            <section class="subpanel">
              <div class="item-header compact bordered">
                <h4 class="title">Payments</h4>
              </div>

              <div class="row" v-for="(p,i) in registrationForm.payments" :key="'pay'+i">
                <div class="grid col8">
                  <template v-for="pf in registrationFields.paymentsRow" :key="pf.col">
                    <label :for="`reg-pay-${i}-${pf.col}`"
                      v-show="isVisible(pf, { row: p, index: i, form: registrationForm })">
                      {{ pf.label }}
                      <small class="error" v-if="registrationErrors?.payments[i]?.[pf.col]">{{
                        registrationErrors?.payments[i]?.[pf.col]
                        }}</small>
                      <template v-if="pf.type==='select'">
                        <select class="input" v-model="p[pf.col]" :id="`reg-pay-${i}-${pf.col}`"
                          :name="`registration.payments[${i}].${pf.col}`"
                          :disabled="getFieldDisabled(pf, {row:p, index:i})"
                          @input="onFormFieldInput(pf, {form: p, index: i }, $event)"
                          @change="onFormFieldChange(pf, {form: p, index: i }, $event)">
                          <option disabled value="">-- choose --</option>
                          <option v-for="opt in getOptions(pf, { form: registrationForm })" :key="String(opt.value)"
                            :value="opt.value">
                            {{ formatOptionLabel(opt) }}
                          </option>
                        </select>
                      </template>

                      <template v-else>
                        <input class="input" :id="`reg-pay-${i}-${pf.col}`"
                          :name="`registration.payments[${i}].${pf.col}`"
                          :disabled="getFieldDisabled(pf, {row:p, index:i})" v-model.trim="p[pf.col]"
                          @input="onFormFieldInput(pf, {form: p, index: i }, $event)"
                          @change="onFormFieldChange(pf, {form: p, index: i }, $event)" />
                      </template>
                    </label>
                  </template>
                </div>
              </div>
            </section>

            <!-- Status and parent acceptance -->
            <section class="subpanel">
              <div class="item-header compact bordered">
                <h4 class="title">Status and Acceptance</h4>
              </div>
              <div class="grid">
                <label v-for="mf in registrationFields.meta" :key="mf.col" :for="`reg-meta-${mf.col}`"
                  v-show="isVisible(mf, {form: registrationForm})">
                  {{ mf.label }}
                  <small class="error" v-if="registrationErrors?.main?.[mf.col]">{{
                    registrationErrors?.main?.[mf.col]
                    }}</small>
                  <template v-if="mf.type==='select'">
                    <select class="input" v-model="registrationForm[mf.col]" :id="`reg-meta-${mf.col}`"
                      :name="`registration.${mf.col}`" :disabled="getFieldDisabled(mf, {form: registrationForm})"
                      @input="onFormFieldInput(mf, {form: registrationForm }, $event)"
                      @change="onFormFieldChange(mf, {form: registrationForm }, $event)">
                      <option v-for="opt in getOptions(mf, { form: registrationForm })" :key="String(opt.value)"
                        :value="opt.value">
                        {{ formatOptionLabel(opt) }}
                      </option>
                    </select>
                  </template>

                  <template v-else>
                    <input class="input" v-model.trim="registrationForm[mf.col]" :id="`reg-meta-${mf.col}`"
                      :name="`registration.${mf.col}`" :disabled="getFieldDisabled(mf, {form: registrationForm})"
                      @input="onFormFieldInput(mf, {form: registrationForm }, $event)"
                      @change="onFormFieldChange(mf, {form: registrationForm }, $event)" />
                  </template>
                </label>
              </div>
            </section>
          </form>
        </section>

        <!-- Registration Receipt Modal -->
        <section v-if="showReceiptModal" class="modal-overlay" @click.self="closeReceipt">
          <div id="receipt-sheet" class="card modal subpanel print-page"
            :data-watermark="receiptView.status === 'paid' ? `PAID ${receiptView.programId} ${receiptView.year}` : ''">
            <div class="item-header compact bordered">
              <h4 class="title">Registration Receipt</h4>
              <div class="spacer"></div>
              <button class="btn small" type="button" @click="printReceipt('#receipt-sheet')">
                <i class="fa-solid fa-print"></i>
              </button>
              <button class="btn small" type="button" @click="closeReceipt">
                <i class="fa-solid fa-xmark"></i>
              </button>
            </div>

            <!-- Main Info -->
            <table class="table">
              <thead>
                <tr>
                  <th>Receipt #</th>
                  <th>Family ID</th>
                  <th>Parish Member</th>
                  <th>Parish Number</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>{{ receiptView.id }}</td>
                  <td>{{ receiptView.familyId }}</td>
                  <td>{{ codeToLabel(receiptView.parishMember, YES_NO_OPTIONS) }}</td>
                  <td>{{ receiptView.parishNumber }}</td>
                </tr>
              </tbody>
            </table>

            <!-- Event -->
            <div class="subpanel">
              <div class="item-header compact bordered">
                <h4 class="title">Registration Event</h4>
              </div>
              <table class="table">
                <thead>
                  <tr>
                    <th>Description</th>
                    <th>Program</th>
                    <th>Event Type</th>
                    <th>School Year</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>{{ receiptView.eventTitle }}</td>
                    <td>{{ codeToLabel(receiptView.programId, PROGRAM_OPTIONS) }}</td>
                    <td>{{ receiptView.eventTypeLabel }}</td>
                    <td>{{ codeToLabel(receiptView.year, YEAR_OPTIONS) }}</td>
                  </tr>
                </tbody>
              </table>
            </div>

            <!-- Family Contacts -->
            <div class="subpanel">
              <div class="item-header compact bordered">
                <h4 class="title">Contacts</h4>
              </div>
              <table class="table">
                <thead>
                  <tr>
                    <th>Relationship</th>
                    <th>Name</th>
                    <th>Phone</th>
                  </tr>
                </thead>
                <tbody>
                  <tr v-for="(c,i) in receiptView.contacts" :key="'ct'+i">
                    <td>{{ c.relationship }}</td>
                    <td>{{ c.name }}</td>
                    <td>{{ c.phone }}</td>
                  </tr>
                  <tr v-if="!receiptView.contacts.length">
                    <td colspan="4" class="muted">No contacts found.</td>
                  </tr>
                </tbody>
              </table>
            </div>

            <!-- Children Enrolled -->
            <div class="subpanel" v-if="receiptView.children && receiptView.children.length">
              <div class="item-header compact bordered">
                <h4 class="title">Children Enrolled</h4>
              </div>
              <table class="table">
                <thead>
                  <tr>
                    <th>Saint Name</th>
                    <th>Full Name</th>
                    <th>Age</th>
                    <th>Grade/Group</th>
                  </tr>
                </thead>
                <tbody>
                  <tr v-for="(c,i) in receiptView.children" :key="'rc'+i">
                    <td>{{ c.saintName }}</td>
                    <td>{{ c.fullName }}</td>
                    <td>{{ c.age }}</td>
                    <td>{{ c.grade }}</td>
                  </tr>
                </tbody>
              </table>
            </div>

            <!-- Payments Data -->
            <div class="subpanel">
              <div class="item-header compact bordered">
                <h4 class="title">Payments</h4>
              </div>
              <table class="table">
                <thead>
                  <tr>
                    <th>Fee</th>
                    <th>Unit</th>
                    <th>Qty</th>
                    <th>Amount</th>
                    <th>Method</th>
                    <th>Receipt #</th>
                    <th>Received By</th>
                  </tr>
                </thead>
                <tbody>
                  <tr v-for="(p,i) in receiptView.payments" :key="'payv'+i">
                    <td>{{ p.codeLabel }}</td>
                    <td>{{ money(p.unitAmount) }}</td>
                    <td>{{ p.qty }}</td>
                    <td>{{ money(p.amount) }}</td>
                    <td>{{ p.method }}</td>
                    <td>{{ p.receiptNo }}</td>
                    <td>{{ p.receivedBy }}</td>
                  </tr>
                  <tr>
                    <td colspan="3" class="right"><strong>Total Paid</strong></td>
                    <td><strong>{{ money(receiptView.total) }}</strong></td>
                    <td colspan="3"></td>
                  </tr>
                </tbody>
              </table>
            </div>

            <!-- Signed / Date -->
            <table class="table">
              <thead>
                <tr>
                  <th></th>
                  <th></th>
                  <th></th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>Accepted & Signed By:</td>
                  <td>{{ receiptView.acceptedBy }}</td>
                  <td>Date:</td>
                  <td>{{ receiptView.updatedAt }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>

      </main>

      <!-- ==================== ROSTERS ========================= -->
      <main v-else-if="SECTION.ROSTERS">
        <!-- List -->
        <section v-if="MODE.LIST" class="page">
          <div class="card">
            <div class="toolbar">
              <input v-model.trim="rosterSearch" class="input" placeholder="Search child name…" />

              <div class="toolbar-filters">
                <!-- School Year -->
                <label class="toolbar-filter">
                  <span>Year</span>
                  <select class="input" v-model="rosterFilter.year">
                    <option value="">All years</option>
                    <option v-for="opt in YEAR_OPTIONS" :key="String(opt.value)" :value="opt.value">
                      {{ opt.label }}
                    </option>
                  </select>
                </label>

                <!-- Program -->
                <label class="toolbar-filter">
                  <span>Program</span>
                  <select class="input" v-model="rosterFilter.programId">
                    <option value="">All programs</option>
                    <option v-for="opt in programOptionsForRoster" :key="String(opt.value)" :value="opt.value">
                      {{ formatOptionLabel(opt) }}
                    </option>
                  </select>
                </label>

                <!-- Event Type -->
                <label class="toolbar-filter">
                  <span>Type</span>
                  <select class="input" v-model="rosterFilter.eventType">
                    <option value="">All types</option>
                    <option v-for="opt in eventTypeOptionsForRoster" :key="String(opt.value)" :value="opt.value">
                      {{ formatOptionLabel(opt) }}
                    </option>
                  </select>
                </label>

                <!-- Event -->
                <label class="toolbar-filter">
                  <span>Event</span>
                  <select class="input" v-model="rosterFilter.eventId">
                    <option value="">All events</option>
                    <option v-for="opt in eventOptionsForRoster" :key="String(opt.value)" :value="opt.value">
                      {{ formatOptionLabel(opt) }}
                    </option>
                  </select>
                </label>

                <!-- Age -->
                <label class="toolbar-filter">
                  <span>Age</span>
                  <select class="input" v-model="rosterFilter.age">
                    <option value="">All Ages</option>
                    <option v-for="opt in ageOptions" :key="String(opt.value)" :value="opt.value">
                      {{ opt.label }}
                    </option>
                  </select>
                </label>

              </div>
              <button tabindex="-1" class="btn small" type="button" @click="resetRosterFilters"
                :disabled="!hasActiveRosterFilter" title="Clear filters">
                Clear
              </button>
            </div>

            <table class="table">
              <thead>
                <tr>
                  <th>Program</th>
                  <th>Year</th>
                  <th>Type</th>
                  <th>Event</th>
                  <th>Saint Name</th>
                  <th>Full Name</th>
                  <th>Grade/Group</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="r in filteredRosterRows" :key="r.registrationId + '-' + r.childId">
                  <td>{{ r.programId }}</td>
                  <td>{{ codeToLabel(r.year, YEAR_OPTIONS) }} </td>
                  <td>{{ codeToLabel(r.eventType, EVENT_TYPES) }}</td>
                  <td>{{ r.eventTitle }}</td>
                  <td>{{ r.saintName }}</td>
                  <td>
                    <a href="#" class="link" title="Child's Contacts" @click.prevent="openChildContactsModal(r)">
                      {{ r.fullName }}
                    </a>
                  </td>
                  <td>{{ r.grade }} </td>
                  <td class="actions">
                    <button tabindex="-1" class="btn secondary" type="button" @click="">
                      <i class="fa-solid fa-pen-to-square"></i> Some Action
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>

        <!-- Roster Contacts Modal -->
        <section v-if="showContactsModal" class="modal-overlay" @click.self="closeChildContactsModal">
          <div class="card modal subpanel">
            <div class="item-header compact bordered">
              <h4 class="title">Family Contacts - ID: <span v-text="contactsModal.familyId"></span></h4>
              <div class="spacer"></div>
              <button class="btn small" type="button" @click="closeChildContactsModal">
                <i class="fa-solid fa-xmark"></i>
              </button>
            </div>

            <div class="grid">
              <label>
                Child Name
                <input class="input" :value="contactsModal.childName" disabled />
              </label>
              <label>
                Age
                <input class="input" :value="contactsModal.age" disabled />
              </label>
              <label v-if="contactsModal.allergies">
                Allergies
                <input class="input" :value="contactsModal.allergies" disabled />
              </label>
            </div>

            <table class="table">
              <thead>
                <tr>
                  <th>Contact Name</th>
                  <th>Relationship</th>
                  <th>Phone</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="(c,i) in contactsModal.contacts" :key="i">
                  <td>{{ c.name }}</td>
                  <td>{{ c.relationship }}</td>
                  <td>{{ c.phone }}</td>
                </tr>
                <tr v-if="contactsModal.contacts.length===0">
                  <td colspan="3" class="muted">No contacts found.</td>
                </tr>
              </tbody>
            </table>
            <div class="footer"></div>
          </div>
        </section>

      </main>

      <!-- ==================== SETTINGS (no list; table layout) ==================== -->
      <main v-else-if="SECTION.SETTINGS">
        <section class="page">
          <form class="card form" @submit.prevent.stop="saveSetup" novalidate autocomplete="off">
            <div class="formtabs-bar">
              <nav class="formtabs" role="tablist" aria-label="Application Settings">
                <button tabindex="-1" type="button" class="active" role="tab" aria-controls="panel-settings">
                  Application Setup
                </button>
              </nav>
              <div class="formtabs-actions">
                <button v-show="MODE.EDIT" type="button" class="btn" @click="READONLY = !READONLY">
                  <i :class="READONLY ? 'fa-solid fa-lock' : 'fa-solid fa-lock-open'"></i>
                </button>
                <button tabindex="-1" type="button" class="btn primary" :disabled="isReadOnly" @click="saveSetup">
                  Save <i class="fa-solid fa-floppy-disk"></i>
                </button>
                <button tabindex="-1" type="button" class="btn" @click="goBackSection(SECTION_NAMES.FAMILIES)">
                  Canel <i class="fa-solid fa-xmark"></i>
                </button>
              </div>
            </div>

            <section id="panel-settings" role="tabpanel" class="panel">
              <!-- Received By -->
              <section class="subpanel">
                <div class="item-header compact bordered">
                  <h4 class="title">Received By</h4>
                  <div class="spacer"></div>
                  <div class="actions">
                    <button class="btn small accent" type="button" :disabled="isReadOnly"
                      @click="setup.receivedBy.push({ value:'', label:'' })">
                      <i class="fa-solid fa-plus"></i>
                    </button>
                  </div>
                </div>
                <table class="table">
                  <thead>
                    <tr>
                      <th>Value</th>
                      <th>Label</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-for="(u,i) in setup.receivedBy" :key="'rb'+i">
                      <td><input class="input" v-model.trim="u.value" :disabled="isReadOnly" /></td>
                      <td><input class="input" v-model.trim="u.label" :disabled="isReadOnly" /></td>
                      <td class="actions">
                        <button class="btn small danger" type="button" :disabled="isReadOnly"
                          @click="setup.receivedBy.splice(i,1)" v-if="setup.receivedBy.length>1">
                          <i class="fa-solid fa-minus"></i>
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </section>

              <!-- Relationships -->
              <section class="subpanel">
                <div class="item-header compact bordered">
                  <h4 class="title">Relationships</h4>
                  <div class="spacer"></div>
                  <div class="actions">
                    <button class="btn small accent" type="button" :disabled="isReadOnly"
                      @click="setup.relationships.push({ value:'', label:'', isParent:false })">
                      <i class="fa-solid fa-plus"></i>
                    </button>
                  </div>
                </div>
                <table class="table">
                  <thead>
                    <tr>
                      <th>Value</th>
                      <th>Label</th>
                      <th>Is Parent?</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-for="(r,i) in setup.relationships" :key="'rel'+i">
                      <td><input class="input" v-model.trim="r.value" :disabled="isReadOnly" /></td>
                      <td><input class="input" v-model.trim="r.label" :disabled="isReadOnly" /></td>
                      <td class="center"><input type="checkbox" class="check-lg" v-model="r.isParent"
                          :disabled="isReadOnly" /></td>
                      <td class="actions">
                        <button class="btn small danger" type="button" :disabled="isReadOnly"
                          @click="setup.relationships.splice(i,1)" v-if="setup.relationships.length>1">
                          <i class="fa-solid fa-minus"></i>
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </section>

              <!-- Programs -->
              <section class="subpanel">
                <div class="item-header compact bordered">
                  <h4 class="title">Programs</h4>
                  <div class="spacer"></div>
                  <div class="actions">
                    <button class="btn small accent" type="button" :disabled="isReadOnly"
                      @click="setup.programs.push({ key:'', value:'', label:'', locked:false })">
                      <i class="fa-solid fa-plus"></i>
                    </button>
                  </div>
                </div>
                <table class="table">
                  <thead>
                    <tr>
                      <th>Key</th>
                      <th>Code</th>
                      <th>Label</th>
                      <th>Locked</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-for="(p,i) in setup.programs" :key="'prog'+i">
                      <td><input class="input" v-model.trim="p.key" :disabled="isReadOnly || p.locked" /></td>
                      <td><input class="input" v-model.trim="p.value" :disabled="isReadOnly || p.locked" /></td>
                      <td><input class="input" v-model.trim="p.label" :disabled="isReadOnly" /></td>
                      <td class="center"><input type="checkbox" class="check-lg" v-model="p.locked"
                          :disabled="isReadOnly" /></td>
                      <td class="actions">
                        <button class="btn small danger" type="button" :disabled="isReadOnly"
                          @click="setup.programs.splice(i,1)" v-if="setup.programs.length>1">
                          <i class="fa-solid fa-minus"></i>
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </section>

              <!-- Event Types -->
              <section class="subpanel">
                <div class="item-header compact bordered">
                  <h4 class="title">Event Types</h4>
                  <div class="spacer"></div>
                  <div class="actions">
                    <button class="btn small accent" type="button" :disabled="isReadOnly"
                      @click="setup.eventTypes.push({ key:'', value:'', label:'', locked:false })">
                      <i class="fa-solid fa-plus"></i>
                    </button>
                  </div>
                </div>
                <table class="table">
                  <thead>
                    <tr>
                      <th>Key</th>
                      <th>Code</th>
                      <th>Label</th>
                      <th>Locked</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-for="(e,i) in setup.eventTypes" :key="'etype'+i">
                      <td><input class="input" v-model.trim="e.key" :disabled="isReadOnly || e.locked" /></td>
                      <td><input class="input" v-model.trim="e.value" :disabled="isReadOnly|| e.locked" /></td>
                      <td><input class="input" v-model.trim="e.label" :disabled="isReadOnly" /></td>
                      <td class="center"><input type="checkbox" class="check-lg" v-model="e.locked"
                          :disabled="isReadOnly" /></td>
                      <td class="actions">
                        <button class="btn small danger" type="button" :disabled="isReadOnly"
                          @click="setup.eventTypes.splice(i,1)" v-if="setup.eventTypes.length>1">
                          <i class="fa-solid fa-minus"></i>
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </section>

              <!-- Levels -->
              <section class="subpanel">
                <div class="item-header compact bordered">
                  <h4 class="title">Levels</h4>
                  <div class="spacer"></div>
                  <div class="actions">
                    <button class="btn small accent" type="button" :disabled="isReadOnly"
                      @click="setup.levels.push({ value:'', label:'', locked:false })">
                      <i class="fa-solid fa-plus"></i>
                    </button>
                  </div>
                </div>
                <table class="table">
                  <thead>
                    <tr>
                      <th>Key</th>
                      <th>Code</th>
                      <th>Label</th>
                      <th>Locked</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-for="(lv,i) in setup.levels" :key="'lvl'+i">
                      <td><input class="input" v-model.trim="lv.key" :disabled="isReadOnly || lv.locked" /></td>
                      <td><input class="input" v-model.trim="lv.value" :disabled="isReadOnly || lv.locked" /></td>
                      <td><input class="input" v-model.trim="lv.label" :disabled="isReadOnly" /></td>
                      <td class="center"><input type="checkbox" class="check-lg" v-model="lv.locked"
                          :disabled="isReadOnly" /></td>
                      <td class="actions">
                        <button class="btn small danger" type="button" :disabled="isReadOnly"
                          @click="setup.levels.splice(i,1)" v-if="setup.levels.length>1">
                          <i class="fa-solid fa-minus"></i>
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </section>

              <!-- Fee Codes -->
              <section class="subpanel">
                <div class="item-header compact bordered">
                  <h4 class="title">Fee Codes</h4>
                  <div class="spacer"></div>
                  <div class="actions">
                    <button class="btn small accent" type="button" :disabled="isReadOnly"
                      @click="setup.feeCodes.push({ key:'', value:'', label:'', locked:false })">
                      <i class="fa-solid fa-plus"></i>
                    </button>
                  </div>
                </div>
                <table class="table">
                  <thead>
                    <tr>
                      <th>Key</th>
                      <th>Code</th>
                      <th>Label</th>
                      <th>Locked</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-for="(f,i) in setup.feeCodes" :key="'fee'+i">
                      <td><input class="input" v-model.trim="f.key" :disabled="isReadOnly || f.locked" /></td>
                      <td><input class="input" v-model.trim="f.value" :disabled="isReadOnly || f.locked" /></td>
                      <td><input class="input" v-model.trim="f.label" :disabled="isReadOnly" /></td>
                      <td class="center"><input type="checkbox" class="check-lg" v-model="f.locked"
                          :disabled="isReadOnly" /></td>
                      <td class="actions">
                        <button class="btn small danger" type="button" :disabled="isReadOnly"
                          @click="setup.feeCodes.splice(i,1)" v-if="setup.feeCodes.length>1">
                          <i class="fa-solid fa-minus"></i>
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </section>

              <!-- Payment Methods -->
              <section class="subpanel">
                <div class="item-header compact bordered">
                  <h4 class="title">Payment Methods</h4>
                  <div class="spacer"></div>
                  <div class="actions">
                    <button class="btn small accent" type="button" :disabled="isReadOnly"
                      @click="setup.paymentMethods.push({ key: '', value:'', label:'', locked: false })">
                      <i class="fa-solid fa-plus"></i>
                    </button>
                  </div>
                </div>
                <table class="table">
                  <thead>
                    <tr>
                      <th>Key</th>
                      <th>Value</th>
                      <th>Label</th>
                      <th>Locked</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-for="(m,i) in setup.paymentMethods" :key="'pm'+i">
                      <td><input class="input" v-model.trim="m.key" :disabled="isReadOnly || m.locked" /></td>
                      <td><input class="input" v-model.trim="m.value" :disabled="isReadOnly || m.locked" /></td>
                      <td><input class="input" v-model.trim="m.label" :disabled="isReadOnly" /></td>
                      <td class="center"><input type="checkbox" class="check-lg" v-model="m.locked"
                          :disabled="isReadOnly" /></td>

                      <td class="actions">
                        <button class="btn small danger" type="button" :disabled="isReadOnly"
                          @click="setup.paymentMethods.splice(i,1)" v-if="setup.paymentMethods.length>1">
                          <i class="fa-solid fa-minus"></i>
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </section>

              <small class="muted">Codes marked “Locked” are used by business rules and existing data; edit labels
                freely.</small>
            </section>
          </form>
        </section>
      </main>

    </transition>
  </div>

  <!-- Axios -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <!-- Vue 3 -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <!-- App -->
  <script src="./js/app.js"></script>
  <div id="print-root" aria-hidden="true"></div>

</body>

</html>