<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>Families & Events â€” Vue Composition API</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="./css/light.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" />
</head>

<body>
  <div id="app" v-cloak>
    <div class="topbar">
      <!-- LEFT: Burger + Breadcrumb -->
      <div class="leftbar">
        <!-- Burger Menu -->
        <div class="menu-wrap" :class="{ open: menuOpen }">
          <button class="btn menu-btn" type="button" @click="menuOpen = !menuOpen" aria-haspopup="menu"
            :aria-expanded="menuOpen">
            <i class="fa-solid fa-bars"></i> <span>Menu</span>
          </button>
          <div v-if="menuOpen" class="clickout-overlay" @click="menuOpen=false"></div>
          <div v-if="menuOpen" class="menu-panel" role="menu">
            <button v-for="m in BURGER_MENU" :key="m.id" class="btn secondary menu-item" type="button" role="menuitem"
              @click="m.onClick(m.id)">
              <i :class="m.icon"></i> {{ m.label }}
            </button>
          </div>
        </div>

        <!-- Breadcrumbs -->
        <div class="crumb">
          <h4 class="crumb-text">
            <template v-for="(c,i) in breadcrumbs" :key="i">
              <template v-if="i>0"> &gt; </template>
              <a v-if="c.onClick" class="link" href="#" @click.prevent="c.onClick">{{ c.label }}</a>
              <span v-else>{{ c.label }}</span>
            </template>
          </h4>
        </div>
      </div>

      <!-- CENTER: Status -->
      <div class="statusbar">
        <div class="status" v-show="status.visible" :data-variant="status.variant">
          <i :class="statusIcon"></i>
          <span v-text="status.text"></span>
        </div>
      </div>

      <!-- RIGHT: Actions -->
      <nav class="actionbar">
        <button v-if="SECTION.FAMILIES && MODE.LIST" class="btn primary" type="button" @click="beginCreateFamily">
          <i class="fa-solid fa-plus"></i> <span>Family</span>
        </button>

        <button v-if="SECTION.EVENTS && MODE.LIST" class="btn primary" type="button" @click="beginCreateEvent">
          <i class="fa-solid fa-plus"></i> <span>Event</span>
        </button>

        <button v-if="SECTION.REGISTRATIONS && MODE.LIST" class="btn primary" type="button"
          @click="beginCreateRegistration">
          <i class="fa-solid fa-plus"></i> <span>Registration</span>
        </button>
      </nav>
    </div>

    <transition name="fade" mode="out-in">
      <!-- ====================== FAMILIES ====================== -->
      <main v-if="SECTION.FAMILIES">
        <!-- List -->
        <section v-if="MODE.LIST" class="page">
          <div class="card">
            <div class="toolbar">
              <input v-model.trim="familySearch" class="input"
                placeholder="Search familyId, membership #, contact name/phone/email, city..." autocomplete="off" />
            </div>
            <table class="table">
              <thead>
                <tr>
                  <th>Family ID</th>
                  <th>Member</th>
                  <th>Parish#</th>
                  <th>Contact Info</th>
                  <th>City</th>
                  <th># Children</th>
                  <th>Actions</th>
                  <th>BPH</th>
                  <th>TNTT</th>
                </tr>
              </thead>
              <tbody>
                <template v-for="f in filteredFamilyRows" :key="f.id">
                  <tr>
                    <td>{{ f.id }}</td>
                    <td class="badge" :data-variant="codeToLabel(f.parishMember, YES_NO_OPTIONS)">{{
                      codeToLabel(f.parishMember, YES_NO_OPTIONS) }}</td>
                    <td>{{ f.parishNumber || '-' }}</td>
                    <td>{{ contactDisplay(f) }}</td>
                    <td>{{ f.address.city }}</td>
                    <td>{{ f.children.length }}</td>
                    <td>
                      <button class="btn secondary" type="button" @click="beginEditFamily(f)">
                        <i class="fa-solid fa-pen-to-square"></i><span>Edit</span>
                      </button>
                    </td>
                    <td>
                      <button
                        :disabled="alreadyRegistered({familyId: f.id, year:getCurrentSchoolYear(), programId: PROGRAM.ADMIN })"
                        class="btn" type="button" @click="beginCreateRegistrationForFamily(f)">
                        <i class="fa-solid fa-clipboard-list"></i>
                        <span>{{alreadyRegistered({familyId: f.id, year:getCurrentSchoolYear(), programId: PROGRAM.ADMIN
                          }) ? 'Paid': 'Register'}}</span>
                      </button>
                    </td>
                    <td>
                      <button
                        v-if="alreadyRegistered({familyId: f.id, year:getCurrentSchoolYear(), programId: PROGRAM.ADMIN })"
                        class="btn" type="button" @click="beginCreateRegistrationForFamily(f)">
                        <i class="fa-solid fa-clipboard-list"></i>
                        <span>Register</span>
                      </button>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </section>

        <!-- Form -->
        <section v-else class="page">
          <form class="card form" @submit.prevent.stop="submitFamilyForm" novalidate autocomplete="off">
            <div class="formtabs-bar">
              <nav class="formtabs" role="tablist" aria-label="Family form sections">
                <button v-for="t in FAMILY_TABS" :key="t.key" type="button" :class="{ active: familyTab===t.key }"
                  role="tab" :aria-selected="familyTab===t.key" :aria-controls="'panel-'+t.key"
                  @click="goFamilyTab(t.key)">
                  {{ t.label }}
                </button>
              </nav>

              <div class="formtabs-actions">
                <button type="button" class="btn primary" @click="submitFamilyForm">
                  {{ MODE.CREATE ? 'Create' : 'Update' }} <i class="far fa-save"></i>
                </button>
                <button type="button" class="btn" @click="goFamilyList">
                  Cancel <i class="fa-solid fa-xmark"></i>
                </button>
              </div>
            </div>

            <!-- Household -->
            <section v-show="familyTab==='household'" id="panel-household" role="tabpanel" class="panel">
              <fieldset :disabled="familyTab!=='household'">
                <div class="item-header compact bordered">
                  <h4 class="title">Household Information</h4>
                </div>

                <div>
                  <div class="grid">
                    <label v-for="f in familyFields.household.main" :key="f.col" :for="`household-${f.col}`"
                      v-show="isVisible(f, {form: familyForm})">
                      {{ f.label }}
                      <small class="error" v-if="familyErrors?.household?.[f.col]">{{ familyErrors.household[f.col]
                        }}</small>

                      <template v-if="f.type === 'select'">
                        <select class="input" :id="`household-${f.col}`" :name="`family.${f.col}`"
                          v-model="familyForm[f.col]"
                          :disabled="getFieldDisabled(f, {mode: currentMode, form: familyForm})"
                          @input="onFormFieldInput(f, {form: familyForm }, $event)"
                          @change="onFormFieldChange(f, {form: familyForm }, $event)">
                          <option disabled value="">-- choose --</option>
                          <option v-for="opt in getOptions(f, {form: familyForm})" :key="String(opt.value)"
                            :value="opt.value">
                            {{ formatOptionLabel(opt) }}
                          </option>
                        </select>
                      </template>

                      <template v-else-if="f.type === 'checkbox'">
                        <input class="check-lg" type="checkbox" :id="`household-${f.col}`" :name="`family.${f.col}`"
                          :disabled="getFieldDisabled(f, {mode: currentMode, form: familyForm})"
                          v-model="familyForm[f.col]" @input="onFormFieldInput(f, {form: familyForm }, $event)"
                          @change="onFormFieldChange(f, {form: familyForm }, $event)" />
                      </template>

                      <template v-else>
                        <input class="input" :type="f.type || 'text'" :id="`household-${f.col}`"
                          :name="`family.${f.col}`" v-model.trim="familyForm[f.col]" :placeholder="f.placeholder"
                          :disabled="getFieldDisabled(f, {mode: currentMode, form: familyForm})"
                          @input="onFormFieldInput(f, {form: familyForm }, $event)"
                          @change="onFormFieldChange(f, {form: familyForm }, $event)" />
                      </template>
                    </label>
                  </div>

                  <div class="grid">
                    <label v-for="f in familyFields.household.address" :key="f.col" :for="`household-address-${f.col}`"
                      v-show="isVisible(f, {form: familyForm})">
                      {{ f.label }}
                      <small class="error" v-if="familyErrors?.household?.[f.col]">{{ familyErrors.household[f.col]
                        }}</small>

                      <template v-if="f.type === 'select'">
                        <select class="input" :id="`household-address-${f.col}`" :name="`family.address.${f.col}`"
                          v-model="familyForm.address[f.col]"
                          :disabled="getFieldDisabled(f, {mode: currentMode, form: familyForm})"
                          @input="onFormFieldInput(f, {form: familyForm }, $event)"
                          @change="onFormFieldChange(f, {form: familyForm }, $event)">
                          <option disabled value="">-- choose --</option>
                          <option v-for="opt in getOptions(f, {form: familyForm})" :key="String(opt.value)"
                            :value="opt.value">
                            {{ formatOptionLabel(opt) }}
                          </option>
                        </select>
                      </template>

                      <template v-else-if="f.type === 'checkbox'">
                        <input class="check-lg" type="checkbox" :id="`household-address-${f.col}`"
                          :name="`family.address.${f.col}`"
                          :disabled="getFieldDisabled(f, {mode: currentMode, form: familyForm})"
                          v-model="familyForm.address[f.col]" @input="onFormFieldInput(f, {form: familyForm }, $event)"
                          @change="onFormFieldChange(f, {form: familyForm }, $event)" />
                      </template>

                      <template v-else>
                        <input class="input" :type="f.type || 'text'" :id="`household-address-${f.col}`"
                          :name="`family.address.${f.col}`"
                          :disabled="getFieldDisabled(f, {mode: currentMode, form: familyForm})"
                          v-model.trim="familyForm.address[f.col]" :placeholder="f.placeholder"
                          @input="onFormFieldInput(f, {form: familyForm }, $event)"
                          @change="onFormFieldChange(f, {form: familyForm }, $event)" />
                      </template>
                    </label>
                  </div>
                </div>
              </fieldset>
            </section>

            <!-- Contacts -->
            <section v-show="familyTab==='contacts'" id="panel-contacts" role="tabpanel" class="panel">
              <fieldset :disabled="familyTab!=='contacts'">
                <div class="item-header compact bordered">
                  <h4 class="title">Contacts Information</h4>
                  <div class="actions">
                    <button type="button" class="btn small accent" @click="addFamilyContact"><i
                        class="fa-solid fa-plus"></i></button>
                  </div>
                  <div class="spacer"></div>
                  <div class="pager" v-if="familyContactsMode==='single'">
                    <button type="button" class="btn small" @click="prevFamilyContact"
                      :disabled="familyContactsIndex===0">â—€</button>
                    <span class="pager-status">{{ familyContactsIndex+1 }} / {{ familyForm.contacts.length }}</span>
                    <button type="button" class="btn small" @click="nextFamilyContact"
                      :disabled="familyContactsIndex>=familyForm.contacts.length-1">â–¶</button>
                  </div>
                  <div class="seg">
                    <button type="button" :class="{ 'seg-active': familyContactsMode==='single' }"
                      @click="familyContactsMode='single'">One</button>
                    <button type="button" :class="{ 'seg-active': familyContactsMode==='all' }"
                      @click="familyContactsMode='all'">All</button>
                  </div>
                </div>

                <div v-for="row in visibleFamilyContacts" :key="'c'+row.i" class="row">
                  <div class="item-header compact">
                    <div class="title">
                      <span>Contact {{row.i + 1}}: {{ row.c.lastName }}, {{ row.c.firstName }}</span>
                    </div>
                    <div class="actions">
                      <button type="button" class="btn small danger" @click="removeFamilyContact(row.i)"
                        v-if="familyForm.contacts.length>1">
                        <i class="fa-solid fa-minus"></i>
                      </button>
                    </div>
                  </div>

                  <div class="grid">
                    <label v-for="f in familyFields.contacts" :key="f.col" :for="`contact-${row.i}-${f.col}`"
                      v-show="isVisible(f, {form: familyForm})">
                      {{ f.label }}
                      <small class="error" v-if="familyErrors?.contacts?.[row.i]?.[f.col]">{{
                        familyErrors.contacts[row.i][f.col] }}</small>

                      <template v-if="f.type === 'select'">
                        <select class="input" :id="`contact-${row.i}-${f.col}`"
                          :name="`family.contacts[${row.i}].${f.col}`"
                          :disabled="getFieldDisabled(f, {mode: currentMode, form: familyForm})" v-model="row.c[f.col]"
                          @input="onFormFieldInput(f, {form: row.c }, $event)"
                          @change="onFormFieldChange(f, {form: row.c }, $event)">
                          <option disabled value="">-- choose --</option>
                          <option v-for="opt in getOptions(f, {form: row.c})" :key="String(opt.value)"
                            :value="opt.value">
                            {{ formatOptionLabel(opt) }}
                          </option>
                        </select>
                      </template>

                      <template v-else-if="f.type === 'checkbox'">
                        <input class="check-lg" type="checkbox" :id="`contact-${row.i}-${f.col}`"
                          :name="`family.contacts[${row.i}].${f.col}`"
                          :disabled="getFieldDisabled(f, {mode: currentMode, form: familyForm})" v-model="row.c[f.col]"
                          @input="onFormFieldInput(f, {form: row.c }, $event)"
                          @change="onFormFieldChange(f, {form: row.c }, $event)" />
                      </template>

                      <template v-else>
                        <input class="input" :type="f.type || 'text'" :id="`contact-${row.i}-${f.col}`"
                          :name="`family.contacts[${row.i}].${f.col}`"
                          :disabled="getFieldDisabled(f, {mode: currentMode, form: familyForm})"
                          v-model.trim="row.c[f.col]" :placeholder="f.placeholder"
                          @input="onFormFieldInput(f, {form: row.c }, $event)"
                          @change="onFormFieldChange(f, {form: row.c }, $event)" />
                      </template>
                    </label>
                  </div>
                </div>
              </fieldset>
            </section>

            <!-- Children -->
            <section v-show="familyTab==='children'" id="panel-children" role="tabpanel" class="panel">
              <fieldset :disabled="familyTab!=='children'">
                <div class="item-header compact bordered">
                  <h4 class="title">Children Information</h4>
                  <span v-html="`of the <strong>${parentLastNamesDisplay}</strong> family`"></span>
                  <div class="actions">
                    <button type="button" class="btn small accent" @click="addFamilyChild">
                      <i class="fa-solid fa-plus"></i>
                    </button>
                  </div>
                  <div class="spacer"></div>
                  <div class="pager" v-if="familyChildrenMode==='single'">
                    <button type="button" class="btn small" @click="prevFamilyChild"
                      :disabled="familyChildrenIndex===0">â—€</button>
                    <span class="pager-status">{{ familyChildrenIndex+1 }} / {{ familyForm.children.length }}</span>
                    <button type="button" class="btn small" @click="nextFamilyChild"
                      :disabled="familyChildrenIndex>=familyForm.children.length-1">â–¶</button>
                  </div>
                  <div class="seg">
                    <button type="button" :class="{ 'seg-active': familyChildrenMode==='single' }"
                      @click="familyChildrenMode='single'">One</button>
                    <button type="button" :class="{ 'seg-active': familyChildrenMode==='all' }"
                      @click="familyChildrenMode='all'">All</button>
                  </div>
                </div>

                <div class="row" v-for="row in visibleFamilyChildren" :key="'k'+row.i">
                  <div class="item-header compact">
                    <div class="title">
                      <span>ID: {{row.c.childId}} - {{displayChildNameAndAge(row.c)}}</span>
                    </div>
                    <div class="actions">
                      <button type="button" class="btn small danger" @click="removeFamilyChild(row.i)"
                        v-if="familyForm.children.length>1">
                        <i class="fa-solid fa-minus"></i>
                      </button>
                    </div>
                  </div>

                  <div class="grid">
                    <label v-for="f in familyFields.children" :key="f.col" :for="`child-${row.i}-${f.col}`"
                      v-show="isVisible(f, {form: familyForm})">
                      {{ f.label }}
                      <small class="error" v-if="familyErrors?.children?.[row.i]?.[f.col]">{{
                        familyErrors.children[row.i][f.col] }}</small>

                      <template v-if="f.type === 'select'">
                        <select class="input" :id="`child-${row.i}-${f.col}`"
                          :name="`family.children[${row.i}].${f.col}`"
                          :disabled="getFieldDisabled(f, {mode: currentMode, form: familyForm})" v-model="row.c[f.col]"
                          @input="onFormFieldInput(f, {form: row.c }, $event)"
                          @change="onFormFieldChange(f, {form: row.c }, $event)">
                          <option disabled value="">-- choose --</option>
                          <option v-for="opt in getOptions(f, {form: familyForm})" :key="String(opt.value)"
                            :value="opt.value">
                            {{ formatOptionLabel(opt) }}
                          </option>
                        </select>
                      </template>

                      <template v-else-if="f.type === 'checkbox'">
                        <input class="check-lg" type="checkbox" :id="`child-${row.i}-${f.col}`"
                          :name="`family.children[${row.i}].${f.col}`"
                          :disabled="getFieldDisabled(f, {mode: currentMode, form: familyForm})" v-model="row.c[f.col]"
                          @input="onFormFieldInput(f, {form: row.c }, $event)"
                          @change="onFormFieldChange(f, {form: row.c }, $event)" />
                      </template>

                      <template v-else>
                        <input class="input" :type="f.type || 'text'" :id="`child-${row.i}-${f.col}`"
                          :name="`family.children[${row.i}].${f.col}`"
                          :disabled="getFieldDisabled(f, {mode: currentMode, form: familyForm})"
                          v-model.trim="row.c[f.col]" :placeholder="f.placeholder"
                          @input="onFormFieldInput(f, {form: row.c }, $event)"
                          @change="onFormFieldChange(f, {form: row.c }, $event)" />
                      </template>
                    </label>
                  </div>
                </div>
              </fieldset>
            </section>
          </form>
        </section>
      </main>

      <!-- ======================= EVENTS ======================= -->
      <main v-else-if="SECTION.EVENTS">
        <!-- List -->
        <section v-if="MODE.LIST" class="page">
          <div class="card">
            <div class="toolbar">
              <input v-model.trim="eventSearch" class="input" placeholder="Search by id, title, type, program, yearâ€¦" />

              <div class="toolbar-filters">
                <!-- Year -->
                <label class="toolbar-filter">
                  <span>Year</span>
                  <select class="input" v-model="eventFilter.year">
                    <option value="">All years</option>
                    <option v-for="opt in YEAR_OPTIONS" :key="String(opt.value)" :value="opt.value">
                      {{ opt.label }}
                    </option>
                  </select>
                </label>
                <!-- Program -->
                <label class="toolbar-filter">
                  <span>Program</span>
                  <select class="input" v-model="eventFilter.programId">
                    <option value="">All programs</option>
                    <option v-for="opt in PROGRAM_OPTIONS" :key="String(opt.value)" :value="opt.value">
                      {{ formatOptionLabel(opt) }}
                    </option>
                  </select>
                </label>

                <!-- Level -->
                <label class="toolbar-filter">
                  <span>Level</span>
                  <select class="input" v-model="eventFilter.level">
                    <option value="">All levels</option>
                    <option v-for="opt in LEVEL_OPTIONS" :key="String(opt.value)" :value="opt.value">
                      {{ formatOptionLabel(opt) }}
                    </option>
                  </select>
                </label>
              </div>
              <button class="btn small" type="button" @click="resetEventFilters" :disabled="!hasActiveEventFilter"
                title="Clear Program/Level/Year filters">
                Clear
              </button>
            </div>

            <table class="table">
              <thead>
                <tr>
                  <th>Event ID</th>
                  <th>Program</th>
                  <th>Type</th>
                  <th>Description</th>
                  <th>School Year</th>
                  <th>Apply</th>
                  <th>Open Window</th>
                  <th>Schedule Fees</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="ev in filteredEventRows" :key="ev.id">
                  <td>{{ ev.id }}</td>
                  <td>{{ ev.programId }}</td>
                  <td>{{ codeToLabel(ev.eventType, EVENT_TYPES) || 'â€”' }}</td>
                  <td>{{ ev.title }}</td>
                  <td>{{ codeToLabel(ev.year, YEAR_OPTIONS) }}</td>
                  <td>{{ codeToLabel(ev.level, LEVEL_OPTIONS) }}</td>
                  <td>{{ ev.openDate }} â†’ {{ ev.endDate }}</td>
                  <td>{{ displayEventFees(ev) }}</td>
                  <td class="actions">
                    <button class="btn secondary" type="button" @click="beginEditEvent(ev)">
                      <i class="fa-solid fa-pen-to-square"></i> Edit
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>

        <!-- Form -->
        <section v-else class="page">
          <form class="card form" @submit.prevent.stop="submitEventForm" novalidate autocomplete="off">
            <div class="formtabs-bar">
              <nav class="formtabs" role="tablist" aria-label="Event Form Section">
                <button type="button" class="active" role="tab" aria-selected="true" aria-controls="panel-event">
                  Event
                </button>
              </nav>

              <div class="formtabs-actions">
                <button type="button" class="btn primary" :disabled="!canSaveEvent" @click="submitEventForm">
                  {{ MODE.CREATE ? 'Create' : 'Update' }} <i class="far fa-save"></i>
                </button>
                <button type="button" class="btn" @click="goEventList">
                  Cancel <i class="fa-solid fa-xmark"></i>
                </button>
              </div>
            </div>

            <!-- Meta-driven main fields -->
            <section class="panel" id="panel-event" role="tabpanel">
              <fieldset>
                <div class="item-header compact bordered">
                  <h4 class="title">Event Information</h4>
                </div>

                <div class="grid">
                  <label v-for="fld in eventFields.main" :key="fld.col" v-show="isVisible(fld, {form: eventForm})"
                    :for="`event-${fld.col}`">
                    {{ fld.label }}
                    <small class="error" v-if="eventErrors[fld.col]">{{ eventErrors[fld.col] }}</small>

                    <template v-if="fld.type === 'select'">
                      <select class="input" v-model="eventForm[fld.col]" :id="`event-${fld.col}`"
                        :name="`event.${fld.col}`"
                        :disabled="getFieldDisabled(fld, {mode: currentMode, form: eventForm})"
                        @input="onFormFieldInput(fld, {form: eventForm }, $event)"
                        @change="onFormFieldChange(fld, {form: eventForm }, $event)">
                        <option disabled value="">-- choose --</option>
                        <option v-for="opt in getOptions(fld, {form: eventForm})" :key="String(opt.value)"
                          :value="opt.value">
                          {{ formatOptionLabel(opt) }}
                        </option>
                      </select>
                    </template>

                    <template v-else-if="fld.type === 'checkbox'">
                      <input class="check-lg" type="checkbox" v-model="eventForm[fld.col]" :id="`event-${fld.col}`"
                        :name="`event.${fld.col}`"
                        :disabled="getFieldDisabled(fld, {mode: currentMode, form: eventForm})"
                        @input="onFormFieldInput(fld, {form: eventForm }, $event)"
                        @change="onFormFieldChange(fld, {form: eventForm }, $event)" />
                    </template>

                    <template v-else>
                      <input class="input" :type="fld.type || 'text'" v-model.trim="eventForm[fld.col]"
                        :id="`event-${fld.col}`" :name="`event.${fld.col}`" :placeholder="fld.placeholder"
                        v-bind="fld.attrs || {}" :disabled="getFieldDisabled(fld, {mode: currentMode, form: eventForm})"
                        @input="onFormFieldInput(fld, {form: eventForm }, $event)"
                        @change="onFormFieldChange(fld, {form: eventForm }, $event)" />
                    </template>
                  </label>
                </div>
              </fieldset>

              <!-- Fees -->
              <div class="subpanel">
                <div class="item-header compact bordered">
                  <h4 class="title">Event Fees</h4>
                  <div class="actions">
                    <button class="btn small accent" type="button" @click="addEventFee">
                      <i class="fa-solid fa-plus"></i>
                    </button>
                  </div>
                  <div class="spacer"></div>
                </div>

                <div class="row" v-for="(row,i) in eventForm.fees" :key="'fee'+i">
                  <div class="grid">
                    <label v-for="rf in eventFields.feeRow" :key="rf.col" :for="`event-fee-${i}-${rf.col}`"
                      v-show="isVisible(rf, {form: row})">
                      {{ rf.label }}
                      <template v-if="rf.type==='select'">
                        <select class="input" v-model="row[rf.col]" :id="`event-fee-${i}-${rf.col}`"
                          :name="`event.fees[${i}].${rf.col}`"
                          :disabled="getFieldDisabled(rf, {mode: currentMode, form: eventForm})"
                          @input="onFormFieldInput(rf, {form: row }, $event)"
                          @change="onFormFieldChange(rf, {form: row }, $event)">
                          <option disabled value="">-- choose --</option>
                          <option v-for="opt in getOptions(rf, {form: eventForm})" :key="String(opt.value)"
                            :value="opt.value">
                            {{ formatOptionLabel(opt) }}
                          </option>
                        </select>
                      </template>
                      <template v-else>
                        <input class="input" :type="rf.type || 'text'" v-model.number="row[rf.col]"
                          :disabled="getFieldDisabled(rf, {mode: currentMode, form: eventForm})"
                          :id="`event-fee-${i}-${rf.col}`" :name="`event.fees[${i}].${rf.col}`" v-bind="rf.attrs || {}"
                          @input="onFormFieldInput(rf, {form: row }, $event)"
                          @change="onFormFieldChange(rf, {form: row }, $event)" />
                      </template>
                    </label>

                    <div class="actions" style="align-self:end">
                      <button class="btn small danger" type="button" @click="removeEventFee(i)"
                        v-if="eventForm.fees.length>1">
                        <i class="fa-solid fa-minus"></i>
                      </button>
                    </div>
                  </div>
                </div>
                <small class="error" v-if="eventErrors.fees">{{ eventErrors.fees }}</small>
              </div>

              <!-- Prerequisites: shown for non-ADM only -->
              <div class="subpanel" v-if="showPrerequisites">
                <div class="item-header compact bordered">
                  <h4 class="title">Event Prerequisites</h4>
                  <div class="actions">
                    <button class="btn small accent" type="button" @click="addEventPrerequisiteRow">
                      <i class="fa-solid fa-plus"></i>
                    </button>
                  </div>
                  <div class="spacer"></div>
                </div>

                <div class="row" v-for="(p, i) in eventForm.prerequisites" :key="'pre'+i">
                  <div class="grid grid--inline">
                    <!-- Driving control -->
                    <template v-for="pf in eventFields.prerequisiteRow" :key="pf.col">
                      <label :for="`event-prereq-${i}-${pf.col}`" v-show="isVisible(pf, {form: p})">
                        {{ pf.label }}
                        <select class="input" v-model="p[pf.col]" :id="`event-prereq-${i}-${pf.col}`"
                          :name="`event.prerequisites[${i}].${pf.col}`"
                          :disabled="getFieldDisabled(pf, {mode: currentMode, form: eventForm})"
                          @input="onFormFieldInput(pf, {form: p }, $event)"
                          @change="onFormFieldChange(pf, {form: p }, $event)">
                          <option disabled value="">-- choose --</option>
                          <option v-for="opt in getOptions(pf, { index:i, form: eventForm })" :key="String(opt.value)"
                            :value="opt.value">
                            {{ formatOptionLabel(opt) }}
                          </option>
                        </select>
                      </label>

                      <!-- Relative displays -->
                      <label v-for="rd in (pf.relativeDisplay || [])" :key="pf.col + '::' + rd.label">
                        {{ rd.label }}
                        <input class="input" :id="`event-prereq-${i}-${pf.col}-${rd.label}`"
                          :name="`event.prerequisites[${i}].rd.${rd.label}`" disabled
                          :value="relativeDisplayValue(p, pf, rd)" />
                      </label>
                    </template>

                    <!-- Actions -->
                    <div class="actions" style="align-self:end">
                      <button class="btn small danger" type="button" @click="removeEventPrerequisiteRow(i)"
                        v-if="eventForm.prerequisites.length>1">
                        <i class="fa-solid fa-minus"></i>
                      </button>
                    </div>
                  </div>
                </div>
                <small class="error" v-if="eventErrors.prerequisites">{{ eventErrors.prerequisites }}</small>
              </div>
            </section>
          </form>
        </section>
      </main>

      <!-- =================== REGISTRATIONS ==================== -->
      <main v-else-if="SECTION.REGISTRATIONS">
        <!-- List -->
        <section v-if="MODE.LIST" class="page">
          <div class="card">
            <div class="toolbar">
              <input v-model.trim="registrationSearch" class="input" placeholder="Search by reg id, event, familyâ€¦" />

              <div class="toolbar-filters">
                <!-- School Year -->
                <label class="toolbar-filter">
                  <span>Year</span>
                  <select class="input" v-model="registrationFilter.year">
                    <option value="">All years</option>
                    <option v-for="opt in YEAR_OPTIONS" :key="String(opt.value)" :value="opt.value">
                      {{ opt.label }}
                    </option>
                  </select>
                </label>

                <!-- Program -->
                <label class="toolbar-filter">
                  <span>Program</span>
                  <select class="input" v-model="registrationFilter.programId">
                    <option value="">All programs</option>
                    <option v-for="opt in PROGRAM_OPTIONS" :key="String(opt.value)" :value="opt.value">
                      {{ formatOptionLabel(opt) }}
                    </option>
                  </select>
                </label>

                <!-- Event Type -->
                <label class="toolbar-filter">
                  <span>Type</span>
                  <select class="input" v-model="registrationFilter.eventType">
                    <option value="">All types</option>
                    <option v-for="opt in EVENT_TYPES" :key="String(opt.value)" :value="opt.value">
                      {{ formatOptionLabel(opt) }}
                    </option>
                  </select>
                </label>
              </div>
              <button class="btn small" type="button" @click="resetRegFilters" :disabled="!hasActiveRegFilter"
                title="Clear filters">
                Clear
              </button>
            </div>

            <table class="table">
              <thead>
                <tr>
                  <th>Reg ID</th>
                  <th>Event</th>
                  <th>School Year</th>
                  <th>Program</th>
                  <th>Family</th>
                  <th>Status</th>
                  <th>Payments</th>
                  <th>Updated</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="r in filteredRegistrationRows" :key="r.id">
                  <td>{{ r.id }}</td>
                  <td> <a href="#" class="link" title="Edit this event" @click.prevent="editEventFromReg(r)">
                      {{ r.event?.title }}
                    </a></td>
                  <td>{{ codeToLabel(r.event?.year, YEAR_OPTIONS) }} </td>
                  <td>{{ r.event?.programId }}</td>
                  <td><a href="#" class="link" title="Edit this family" @click.prevent="editFamilyFromReg(r)">
                      {{ r.contacts[0]?.name || r.familyId }} {{ maskLast4(r.contacts[0]?.phone) }}
                    </a></td>
                  <td class="badge" :data-variant="r.status">{{ r.status }}</td>
                  <td>{{ (r.payments||[]).map(p=>p.code+':$'+p.amount).join(' / ') }}</td>
                  <td>{{ (r.updatedAt||r.createdAt||'').slice(0,10) }}</td>
                  <td class="actions">
                    <button class="btn secondary" type="button" @click="beginEditRegistration(r)">
                      <i class="fa-solid fa-pen-to-square"></i> Edit
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>

        <!-- Form -->
        <section v-else class="page">
          <form class="card form" @submit.prevent.stop="submitRegistrationForm" novalidate autocomplete="off">
            <div class="formtabs-bar">
              <nav class="formtabs" role="tablist" aria-label="Registration form sections">
                <button v-for="t in REG_TABS" :key="t.key" type="button" :class="{ active: regTab===t.key }" role="tab"
                  :aria-selected="regTab===t.key" :aria-controls="'panel-'+t.key" @click="goRegTab(t.key)">
                  {{ t.label }}
                </button>
              </nav>
              <div class="formtabs-actions">
                <button type="button" class="btn primary" :disabled="!canSaveRegistration"
                  @click="submitRegistrationForm">
                  {{ MODE.CREATE ? 'Create' : 'Update' }} <i class="far fa-save"></i>
                </button>
                <button type="button" class="btn" @click="goRegistrationList">
                  Cancel <i class="fa-solid fa-xmark"></i>
                </button>
              </div>
            </div>

            <!-- Main Tab -->
            <section v-show="regTab==='main'" id="panel-reg-main" role="tabpanel" class="panel">
              <fieldset :disabled="regTab!=='main'">
                <div class="item-header compact bordered">
                  <h4 class="title">Event & Family</h4>
                </div>

                <div class="grid">
                  <label v-for="fld in registrationFields.main" :key="fld.col"
                    v-show="isVisible(fld, {form: registrationForm})" :for="`reg-${fld.col}`">
                    {{ fld.label }}
                    <small class="error" v-if="registrationErrors?.main?.[fld.col]">{{ registrationErrors.main[fld.col]
                      }}</small>

                    <template v-if="fld.type === 'select'">
                      <select class="input" v-model="registrationForm[fld.col]" :id="`reg-${fld.col}`"
                        :name="`registration.${fld.col}`"
                        :disabled="getFieldDisabled(fld, {mode: currentMode, form: registrationForm})"
                        @input="onFormFieldInput(fld, {form: registrationForm }, $event)"
                        @change="onFormFieldChange(fld, {form: registrationForm }, $event)">
                        <option disabled value="">-- choose --</option>
                        <option v-for="opt in getOptions(fld, { form: registrationForm })" :key="String(opt.value)"
                          :value="opt.value">
                          {{ formatOptionLabel(opt) }}
                        </option>
                      </select>
                    </template>

                    <template v-else-if="fld.type === 'datalist'">
                      <input class="input" list="family-datalist" v-model="registrationForm[fld.col]"
                        :id="`reg-${fld.col}`" :name="`registration.${fld.col}`"
                        :placeholder="fld.placeholder || 'Start typingâ€¦'"
                        :disabled="getFieldDisabled(fld, {mode: currentMode, form: registrationForm})"
                        @input="onFormFieldInput(fld, {form: registrationForm }, $event)"
                        @change="onFormFieldChange(fld, {form: registrationForm }, $event)" />
                    </template>

                    <template v-else>
                      <input class="input" :type="fld.type || 'text'" v-model.trim="registrationForm[fld.col]"
                        :id="`reg-${fld.col}`" :name="`registration.${fld.col}`" :placeholder="fld.placeholder"
                        :disabled="getFieldDisabled(fld, {mode: currentMode, form: registrationForm})"
                        @input="onFormFieldInput(fld, {form: registrationForm }, $event)"
                        @change="onFormFieldChange(fld, {form: registrationForm }, $event)" />
                    </template>
                  </label>
                </div>

                <!-- datalist source for Family autocomplete -->
                <datalist id="family-datalist">
                  <option v-for="opt in familyDatalistOptions" :key="opt.value" :value="opt.value">{{ opt.label }}
                  </option>
                </datalist>

                <!-- Event snapshot (disabled via meta) -->
                <div class="subpanel">
                  <div class="item-header compact bordered">
                    <h4 class="title">Event Snapshot</h4>
                  </div>
                  <div class="grid">
                    <label v-for="f in registrationFields.eventSnapshot" :key="f.col" :for="`reg-event-${f.col}`"
                      v-show="isVisible(f, {form: registrationForm})">
                      {{ f.label }}
                      <input class="input" :id="`reg-event-${f.col}`" :name="`registration.event.${f.col}`"
                        :disabled="getFieldDisabled(f, {form: registrationForm})"
                        :value="f.transform ? f.transform(registrationForm.event[f.col]) : registrationForm.event[f.col]" />
                    </label>
                  </div>
                </div>

                <!-- Contacts snapshot (disabled via meta) -->
                <div class="subpanel">
                  <div class="item-header compact bordered">
                    <h4 class="title">Contacts Snapshot</h4>
                  </div>
                  <div class="grid col3">
                    <template v-for="(c, i) in registrationForm.contacts" :key="'rc'+i">
                      <label v-for="cf in registrationFields.contactSnapshot" :key="cf.col + i"
                        :for="`reg-contact-${i}-${cf.col}`" v-show="isVisible(cf, {form: registrationForm})">
                        {{ cf.label }}
                        <input class="input" :id="`reg-contact-${i}-${cf.col}`"
                          :name="`registration.contacts[${i}].${cf.col}`"
                          :disabled="getFieldDisabled(cf, {form: registrationForm})" :value="c[cf.col]" />
                      </label>
                    </template>
                  </div>
                </div>
              </fieldset>
            </section>

            <!-- Registration Tab -->
            <section v-show="regTab==='registration'" id="panel-reg-registration" role="tabpanel" class="panel">
              <fieldset :disabled="regTab!=='registration'">


                <!-- Children selection for PC events -->
                <div class="subpanel" v-if="selectedEventLevel === LEVEL.PER_CHILD">
                  <div class="item-header compact bordered">
                    <h4 class="title">Children Enrollment</h4>
                    <div class="actions">
                      <button class="btn small accent" type="button" @click="addRegChildRow"
                        :disabled="availableChildOptions.length===0">
                        <i class="fa-solid fa-plus"></i>
                      </button>
                    </div>
                    <div class="spacer"></div>
                    <small class="error" v-if="registrationErrors?.main?.childrenRoot">{{
                      registrationErrors?.main?.childrenRoot
                      }}</small>
                  </div>

                  <div class="row" v-for="(row,i) in registrationForm.children" :key="'ch'+i">
                    <div class="grid col5">
                      <template v-for="cf in registrationFields.childrenRow" :key="cf.col">
                        <label :for="`reg-child-${i}-${cf.col}`" v-show="isVisible(cf, {form: row})">
                          {{ cf.label }}
                          <small class="error" v-if="registrationErrors?.children?.[i]?.[cf.col]">{{
                            registrationErrors.children[i]?.[cf.col] }}</small>
                          <template v-if="cf.type === 'select'">
                            <select class="input" v-model="row[cf.col]" :id="`reg-child-${i}-${cf.col}`"
                              :name="`registration.children[${i}].${cf.col}`"
                              :disabled="getFieldDisabled(cf, {row: row, index: i})"
                              @input="onFormFieldInput(cf, {form: row, index: i }, $event)"
                              @change="onFormFieldChange(cf, {form: row, index: i }, $event)">
                              <option disabled value="">-- choose --</option>
                              <option v-for="opt in getOptions(cf, {form: row, index: i })" :key="String(opt.value)"
                                :value="opt.value">{{ formatOptionLabel(opt)}}</option>
                            </select>

                          </template>
                          <template v-else-if="cf.type === 'text'">
                            <input class="input" :id="`reg-child-${i}-${cf.col}`"
                              :name="`registration.children[${i}].${cf.col}`"
                              :disabled="getFieldDisabled(cf, {row: row, index: i})"
                              :value="cf.transform ? cf.transform(row[cf.col]) : row[cf.col]"
                              @input="onFormFieldInput(cf, {form: row, index: i }, $event)"
                              @change="onFormFieldChange(cf, {form: row, index: i }, $event)" />

                          </template>
                        </label>

                      </template>

                      <div class="actions">
                        <button class="btn small danger" type="button" @click="removeRegChildRow(i)">
                          <i class="fa-solid fa-minus"></i>
                        </button>
                      </div>
                    </div>

                  </div>
                </div>

                <!-- Payments (prefilled, fixed rows) -->
                <div class="subpanel">
                  <div class="item-header compact bordered">
                    <h4 class="title">Payments</h4>
                  </div>

                  <div class="row" v-for="(p,i) in registrationForm.payments" :key="'pay'+i">
                    <div class="grid">
                      <template v-for="pf in registrationFields.paymentsRow" :key="pf.col">
                        <label :for="`reg-pay-${i}-${pf.col}`"
                          v-show="isVisible(pf, { row: p, index: i, form: registrationForm })">
                          {{ pf.label }}
                          <small class="error" v-if="registrationErrors?.payments[i]?.[pf.col]">{{
                            registrationErrors?.payments[i]?.[pf.col]
                            }}</small>
                          <template v-if="pf.type==='select'">
                            <select class="input" v-model="p[pf.col]" :id="`reg-pay-${i}-${pf.col}`"
                              :name="`registration.payments[${i}].${pf.col}`"
                              :disabled="getFieldDisabled(pf, {row:p, index:i})"
                              @input="onFormFieldInput(pf, {form: p, index: i }, $event)"
                              @change="onFormFieldChange(pf, {form: p, index: i }, $event)">
                              <option disabled value="">-- choose --</option>
                              <option v-for="opt in getOptions(pf, { form: registrationForm })" :key="String(opt.value)"
                                :value="opt.value">
                                {{ formatOptionLabel(opt) }}
                              </option>
                            </select>
                          </template>

                          <template v-else>
                            <input class="input" :id="`reg-pay-${i}-${pf.col}`"
                              :name="`registration.payments[${i}].${pf.col}`"
                              :disabled="getFieldDisabled(pf, {row:p, index:i})" v-model.trim="p[pf.col]"
                              @input="onFormFieldInput(pf, {form: p, index: i }, $event)"
                              @change="onFormFieldChange(pf, {form: p, index: i }, $event)" />
                          </template>
                        </label>
                      </template>
                    </div>
                  </div>
                </div>

                <!-- Status and parent acceptance -->
                <div class="subpanel">
                  <div class="item-header compact bordered">
                    <h4 class="title">Status and Acceptance</h4>
                  </div>
                  <div class="grid">
                    <label v-for="mf in registrationFields.meta" :key="mf.col" :for="`reg-meta-${mf.col}`"
                      v-show="isVisible(mf, {form: registrationForm})">
                      {{ mf.label }}
                      <small class="error" v-if="registrationErrors?.main?.[mf.col]">{{
                        registrationErrors?.main?.[mf.col]
                        }}</small>
                      <template v-if="mf.type==='select'">
                        <select class="input" v-model="registrationForm[mf.col]" :id="`reg-meta-${mf.col}`"
                          :name="`registration.${mf.col}`" :disabled="getFieldDisabled(mf, {form: registrationForm})"
                          @input="onFormFieldInput(mf, {form: registrationForm }, $event)"
                          @change="onFormFieldChange(mf, {form: registrationForm }, $event)">
                          <option v-for="opt in getOptions(mf, { form: registrationForm })" :key="String(opt.value)"
                            :value="opt.value">
                            {{ formatOptionLabel(opt) }}
                          </option>
                        </select>
                      </template>

                      <template v-else>
                        <input class="input" v-model.trim="registrationForm[mf.col]" :id="`reg-meta-${mf.col}`"
                          :name="`registration.${mf.col}`" :disabled="getFieldDisabled(mf, {form: registrationForm})"
                          @input="onFormFieldInput(mf, {form: registrationForm }, $event)"
                          @change="onFormFieldChange(mf, {form: registrationForm }, $event)" />
                      </template>
                    </label>
                  </div>
                </div>
              </fieldset>
            </section>
          </form>
        </section>
      </main>
    </transition>
  </div>

  <!-- Axios -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <!-- Vue 3 -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <!-- App -->
  <script src="./js/app.js"></script>
</body>

</html>